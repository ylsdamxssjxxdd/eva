
<!doctype html>
<html lang="zh" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="EVA 机体用户与开发者文档（本地/链接双模，工具与增殖全流程）">
      
      
        <meta name="author" content="EVA Team">
      
      
        <link rel="canonical" href="https://ylsdamxssjxxdd.github.io/eva/%E8%BD%AF%E4%BB%B6%E6%8A%80%E6%9C%AF%E8%AF%B4%E6%98%8E%E4%B9%A6/">
      
      
        <link rel="prev" href="../%E4%BD%BF%E7%94%A8%E8%AF%B4%E6%98%8E%E4%B9%A6/">
      
      
        <link rel="next" href="../%E6%9C%BA%E4%BD%93%E8%8A%82%E7%82%B9%E4%B8%8E%E7%8A%B6%E6%80%81%E6%A2%B3%E7%90%86/">
      
      
        
      
      
      <link rel="icon" href="../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.7.3">
    
    
      
        <title>软件技术说明书 - EVA 文档</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.484c7ddc.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
  </head>
  
  
    <body dir="ltr">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#eva" class="md-skip">
          跳转至
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="页眉">
    <a href=".." title="EVA 文档" class="md-header__button md-logo" aria-label="EVA 文档" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            EVA 文档
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              软件技术说明书
            
          </span>
        </div>
      </div>
    </div>
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="搜索" placeholder="搜索" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="查找">
        
        <button type="reset" class="md-search__icon md-icon" title="清空当前内容" aria-label="清空当前内容" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
        <div class="md-search__suggest" data-md-component="search-suggest"></div>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            正在初始化搜索引擎
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="导航栏" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href=".." title="EVA 文档" class="md-nav__button md-logo" aria-label="EVA 文档" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    EVA 文档
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href=".." class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    首页
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
      
        
        
      
    
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_2" >
        
          
          <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="">
            
  
  
  <span class="md-ellipsis">
    
  
    快速使用
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            
  
    快速使用
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../pages/01-%E5%AF%B9%E8%AF%9D/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    对话
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../pages/02-%E8%A1%A5%E5%AE%8C/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    补完
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../pages/03-%E8%AF%AD%E9%9F%B3%E4%BA%A4%E4%BA%92/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    语音交互
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../pages/04-%E8%A7%86%E8%A7%89%E4%BA%A4%E4%BA%92/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    视觉交互
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../pages/05-%E6%96%87%E7%94%9F%E5%9B%BE/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    文生图
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../pages/06-%E7%9F%A5%E8%AF%86%E5%BA%93/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    知识库
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../pages/07-MCP/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    MCP
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../pages/08-%E7%B3%BB%E7%BB%9F%E5%B7%A5%E7%A8%8B%E5%B8%88/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    系统工程师
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../pages/09-%E4%BD%BF%E7%94%A8%E6%B2%99%E7%9B%92/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    使用沙盒
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../pages/10-%E4%BD%BF%E7%94%A8%E6%8A%80%E8%83%BD/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    使用技能
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../pages/11-%E7%B3%BB%E7%BB%9F%E6%9E%B6%E6%9E%84%E5%B8%88/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    系统架构师
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../pages/12-%E6%9C%BA%E4%BD%93%E6%8E%A7%E5%88%B6/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    机体控制
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../pages/13-%E6%A1%8C%E9%9D%A2%E6%8E%A7%E5%88%B6%E5%99%A8/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    桌面控制器
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
    
    
      
        
        
      
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3" checked>
        
          
          <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="">
            
  
  
  <span class="md-ellipsis">
    
  
    其他文档
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            
  
    其他文档
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../%E4%BD%BF%E7%94%A8%E8%AF%B4%E6%98%8E%E4%B9%A6/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    使用说明书
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  
  <span class="md-ellipsis">
    
  
    软件技术说明书
  

    
  </span>
  
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  
  <span class="md-ellipsis">
    
  
    软件技术说明书
  

    
  </span>
  
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="目录">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      目录
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#1" class="md-nav__link">
    <span class="md-ellipsis">
      
        1. 范围与读者
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#2" class="md-nav__link">
    <span class="md-ellipsis">
      
        2. 技术基线
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#3" class="md-nav__link">
    <span class="md-ellipsis">
      
        3. 术语表
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#4" class="md-nav__link">
    <span class="md-ellipsis">
      
        4. 架构概览
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="4. 架构概览">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#41" class="md-nav__link">
    <span class="md-ellipsis">
      
        4.1 组件职责
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#42" class="md-nav__link">
    <span class="md-ellipsis">
      
        4.2 中央教条
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#5" class="md-nav__link">
    <span class="md-ellipsis">
      
        5. 运行模式与状态
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="5. 运行模式与状态">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#51" class="md-nav__link">
    <span class="md-ellipsis">
      
        5.1 模式与状态
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#52-ui" class="md-nav__link">
    <span class="md-ellipsis">
      
        5.2 UI 状态机
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#53-ui" class="md-nav__link">
    <span class="md-ellipsis">
      
        5.3 UI 辅助元素
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#6" class="md-nav__link">
    <span class="md-ellipsis">
      
        6. 核心工作流
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="6. 核心工作流">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#61" class="md-nav__link">
    <span class="md-ellipsis">
      
        6.1 本地装载流程
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#62" class="md-nav__link">
    <span class="md-ellipsis">
      
        6.2 链接模式装载
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#63" class="md-nav__link">
    <span class="md-ellipsis">
      
        6.3 发送 / 推理流程
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#64" class="md-nav__link">
    <span class="md-ellipsis">
      
        6.4 工具循环
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#65" class="md-nav__link">
    <span class="md-ellipsis">
      
        6.5 多模态输入
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#66" class="md-nav__link">
    <span class="md-ellipsis">
      
        6.6 自动弹出（惰性卸载）
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#67" class="md-nav__link">
    <span class="md-ellipsis">
      
        6.7 本地代理实现
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#7" class="md-nav__link">
    <span class="md-ellipsis">
      
        7. 工具体系与安全
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="7. 工具体系与安全">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#71" class="md-nav__link">
    <span class="md-ellipsis">
      
        7.1 内置工具
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#72-mcp" class="md-nav__link">
    <span class="md-ellipsis">
      
        7.2 MCP 集成
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#73" class="md-nav__link">
    <span class="md-ellipsis">
      
        7.3 安全边界
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#74" class="md-nav__link">
    <span class="md-ellipsis">
      
        7.4 工具调用流程图
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#75" class="md-nav__link">
    <span class="md-ellipsis">
      
        7.5 技能系统整合
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#8" class="md-nav__link">
    <span class="md-ellipsis">
      
        8. 增殖能力总览
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="8. 增殖能力总览">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#81" class="md-nav__link">
    <span class="md-ellipsis">
      
        8.1 知识库
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#82" class="md-nav__link">
    <span class="md-ellipsis">
      
        8.2 文生图
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#83" class="md-nav__link">
    <span class="md-ellipsis">
      
        8.3 声转文 / 文转声
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#84" class="md-nav__link">
    <span class="md-ellipsis">
      
        8.4 模型信息与量化
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#9" class="md-nav__link">
    <span class="md-ellipsis">
      
        9. 运行时管理
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="9. 运行时管理">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#91" class="md-nav__link">
    <span class="md-ellipsis">
      
        9.1 后端目录约束
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#92-gpu-offload" class="md-nav__link">
    <span class="md-ellipsis">
      
        9.2 GPU offload 策略
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#93" class="md-nav__link">
    <span class="md-ellipsis">
      
        9.3 自动目录
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#10" class="md-nav__link">
    <span class="md-ellipsis">
      
        10. 配置与持久化
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#11" class="md-nav__link">
    <span class="md-ellipsis">
      
        11. 观测与评估
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="11. 观测与评估">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#111-sse" class="md-nav__link">
    <span class="md-ellipsis">
      
        11.1 SSE 观测
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#112" class="md-nav__link">
    <span class="md-ellipsis">
      
        11.2 模型评估模块
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#113-terminalpane" class="md-nav__link">
    <span class="md-ellipsis">
      
        11.3 TerminalPane 监控
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#11-docker" class="md-nav__link">
    <span class="md-ellipsis">
      
        11. Docker 沙盒机制
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="11. Docker 沙盒机制">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#111" class="md-nav__link">
    <span class="md-ellipsis">
      
        11.1 启用流程
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#112_1" class="md-nav__link">
    <span class="md-ellipsis">
      
        11.2 路径映射与工具执行
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#113" class="md-nav__link">
    <span class="md-ellipsis">
      
        11.3 持久化与生命周期
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#114" class="md-nav__link">
    <span class="md-ellipsis">
      
        11.4 兼容性与注意事项
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#12" class="md-nav__link">
    <span class="md-ellipsis">
      
        12. 部署与发布
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#13" class="md-nav__link">
    <span class="md-ellipsis">
      
        13. 测试与验证
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#14" class="md-nav__link">
    <span class="md-ellipsis">
      
        14. 关键文件索引
      
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../%E6%9C%BA%E4%BD%93%E8%8A%82%E7%82%B9%E4%B8%8E%E7%8A%B6%E6%80%81%E6%A2%B3%E7%90%86/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    机体节点与状态梳理
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../%E6%96%87%E6%A1%A3%E8%A7%A3%E6%9E%90/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    文档解析
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../%E5%8A%9F%E8%83%BD%E8%BF%AD%E4%BB%A3/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    功能迭代
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="目录">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      目录
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#1" class="md-nav__link">
    <span class="md-ellipsis">
      
        1. 范围与读者
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#2" class="md-nav__link">
    <span class="md-ellipsis">
      
        2. 技术基线
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#3" class="md-nav__link">
    <span class="md-ellipsis">
      
        3. 术语表
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#4" class="md-nav__link">
    <span class="md-ellipsis">
      
        4. 架构概览
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="4. 架构概览">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#41" class="md-nav__link">
    <span class="md-ellipsis">
      
        4.1 组件职责
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#42" class="md-nav__link">
    <span class="md-ellipsis">
      
        4.2 中央教条
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#5" class="md-nav__link">
    <span class="md-ellipsis">
      
        5. 运行模式与状态
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="5. 运行模式与状态">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#51" class="md-nav__link">
    <span class="md-ellipsis">
      
        5.1 模式与状态
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#52-ui" class="md-nav__link">
    <span class="md-ellipsis">
      
        5.2 UI 状态机
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#53-ui" class="md-nav__link">
    <span class="md-ellipsis">
      
        5.3 UI 辅助元素
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#6" class="md-nav__link">
    <span class="md-ellipsis">
      
        6. 核心工作流
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="6. 核心工作流">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#61" class="md-nav__link">
    <span class="md-ellipsis">
      
        6.1 本地装载流程
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#62" class="md-nav__link">
    <span class="md-ellipsis">
      
        6.2 链接模式装载
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#63" class="md-nav__link">
    <span class="md-ellipsis">
      
        6.3 发送 / 推理流程
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#64" class="md-nav__link">
    <span class="md-ellipsis">
      
        6.4 工具循环
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#65" class="md-nav__link">
    <span class="md-ellipsis">
      
        6.5 多模态输入
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#66" class="md-nav__link">
    <span class="md-ellipsis">
      
        6.6 自动弹出（惰性卸载）
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#67" class="md-nav__link">
    <span class="md-ellipsis">
      
        6.7 本地代理实现
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#7" class="md-nav__link">
    <span class="md-ellipsis">
      
        7. 工具体系与安全
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="7. 工具体系与安全">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#71" class="md-nav__link">
    <span class="md-ellipsis">
      
        7.1 内置工具
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#72-mcp" class="md-nav__link">
    <span class="md-ellipsis">
      
        7.2 MCP 集成
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#73" class="md-nav__link">
    <span class="md-ellipsis">
      
        7.3 安全边界
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#74" class="md-nav__link">
    <span class="md-ellipsis">
      
        7.4 工具调用流程图
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#75" class="md-nav__link">
    <span class="md-ellipsis">
      
        7.5 技能系统整合
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#8" class="md-nav__link">
    <span class="md-ellipsis">
      
        8. 增殖能力总览
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="8. 增殖能力总览">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#81" class="md-nav__link">
    <span class="md-ellipsis">
      
        8.1 知识库
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#82" class="md-nav__link">
    <span class="md-ellipsis">
      
        8.2 文生图
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#83" class="md-nav__link">
    <span class="md-ellipsis">
      
        8.3 声转文 / 文转声
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#84" class="md-nav__link">
    <span class="md-ellipsis">
      
        8.4 模型信息与量化
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#9" class="md-nav__link">
    <span class="md-ellipsis">
      
        9. 运行时管理
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="9. 运行时管理">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#91" class="md-nav__link">
    <span class="md-ellipsis">
      
        9.1 后端目录约束
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#92-gpu-offload" class="md-nav__link">
    <span class="md-ellipsis">
      
        9.2 GPU offload 策略
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#93" class="md-nav__link">
    <span class="md-ellipsis">
      
        9.3 自动目录
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#10" class="md-nav__link">
    <span class="md-ellipsis">
      
        10. 配置与持久化
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#11" class="md-nav__link">
    <span class="md-ellipsis">
      
        11. 观测与评估
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="11. 观测与评估">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#111-sse" class="md-nav__link">
    <span class="md-ellipsis">
      
        11.1 SSE 观测
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#112" class="md-nav__link">
    <span class="md-ellipsis">
      
        11.2 模型评估模块
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#113-terminalpane" class="md-nav__link">
    <span class="md-ellipsis">
      
        11.3 TerminalPane 监控
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#11-docker" class="md-nav__link">
    <span class="md-ellipsis">
      
        11. Docker 沙盒机制
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="11. Docker 沙盒机制">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#111" class="md-nav__link">
    <span class="md-ellipsis">
      
        11.1 启用流程
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#112_1" class="md-nav__link">
    <span class="md-ellipsis">
      
        11.2 路径映射与工具执行
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#113" class="md-nav__link">
    <span class="md-ellipsis">
      
        11.3 持久化与生命周期
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#114" class="md-nav__link">
    <span class="md-ellipsis">
      
        11.4 兼容性与注意事项
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#12" class="md-nav__link">
    <span class="md-ellipsis">
      
        12. 部署与发布
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#13" class="md-nav__link">
    <span class="md-ellipsis">
      
        13. 测试与验证
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#14" class="md-nav__link">
    <span class="md-ellipsis">
      
        14. 关键文件索引
      
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              
              <article class="md-content__inner md-typeset">
                
                  



<h1 id="eva">机体 EVA 软件技术说明书<a class="headerlink" href="#eva" title="Permanent link">&para;</a></h1>
<p>本说明书面向 EVA 机体的研发、测试、运维与产品团队，提供一份结构化、可执行的系统指南。文档按照“从整体到细部、从职责到流程、从运行到运维”的逻辑展开，确保在遵循中央教条的同时具备良好可维护性。</p>
<h2 id="1">1. 范围与读者<a class="headerlink" href="#1" title="Permanent link">&para;</a></h2>
<ul>
<li>
<p><strong>研发与架构</strong>：理解整体设计、组件接口、扩展点，指导开发与重构。</p>
</li>
<li>
<p><strong>测试与运维</strong>：掌握运行模式、状态切换与日志来源，支持部署、回归与排障。</p>
</li>
<li>
<p><strong>产品与文档</strong>：明确能力边界、交互流程与术语，确保对外一致性。</p>
</li>
</ul>
<h2 id="2">2. 技术基线<a class="headerlink" href="#2" title="Permanent link">&para;</a></h2>
<ul>
<li>
<p><strong>语言 / 框架</strong>：C++17 + Qt 5.15。</p>
</li>
<li>
<p><strong>平台</strong>：Windows、Linux（含 AppImage）。GPU 后端支持 CUDA / Vulkan / OpenCL / CPU。</p>
</li>
<li>
<p><strong>本地推理内核</strong>：llama.cpp（server 模式）。</p>
</li>
<li>
<p><strong>远端协议</strong>：OpenAI 兼容 API（<code>/v1/chat/completions</code>、<code>/v1/completions</code>）。</p>
</li>
<li>
<p><strong>第三方组件</strong>：whisper.cpp（ASR）、Stable Diffusion/Flux（文生图）、tts.cpp（TTS）。</p>
</li>
<li>
<p><strong>编码规范</strong>：UTF-8（无 BOM），默认换行 LF。</p>
</li>
</ul>
<h2 id="3">3. 术语表<a class="headerlink" href="#3" title="Permanent link">&para;</a></h2>
<p>| 术语 | 含义 |</p>
<p>| --- | --- |</p>
<p>| 机体 / EVA | 本项目的桌面应用（大前端）。 |</p>
<p>| 约定框架 / data framework | 通过系统提示与输出解析限制模型行为的行动接口。 |</p>
<p>| 素体 | 人的欲望。 |</p>
<p>| 驾驶员 | 大语言模型（本地 gguf / 远端模型名）。 |</p>
<p>| 指挥员 | 用户。 |</p>
<p>| 四大类 | <code>net</code>（网络）、<code>widget</code>（窗口/UI）、<code>tool</code>（工具）、<code>expend</code>（增殖）。 |</p>
<p>| 拘束器 | 解析模型输出、抽取工具请求的逻辑。 |</p>
<p>| 朗基努斯之枪 | 象征“残酷的现实”，即现实回执与真值校准机制。用于抑制欲望失控、刺穿执念，并要求系统以可验证结果决策。 |</p>
<h2 id="4">4. 架构概览<a class="headerlink" href="#4" title="Permanent link">&para;</a></h2>
<div class="codehilite"><pre><span></span><code><span class="n">flowchart</span><span class="w"> </span><span class="n">LR</span>

<span class="w">  </span><span class="n">subgraph</span><span class="w"> </span><span class="n">UI</span><span class="p">[</span><span class="n">Widget</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">Expend</span><span class="p">]</span>

<span class="w">    </span><span class="n">INP</span><span class="p">[</span><span class="n">输入区域</span><span class="err">\</span><span class="n">n文本</span><span class="o">/</span><span class="n">图片</span><span class="o">/</span><span class="n">音频</span><span class="p">]</span>

<span class="w">    </span><span class="n">BTN</span><span class="p">[</span><span class="n">装载</span><span class="o">/</span><span class="n">约定</span><span class="o">/</span><span class="n">设置</span><span class="o">/</span><span class="n">重置</span><span class="o">/</span><span class="n">发送</span><span class="p">]</span>

<span class="w">    </span><span class="n">OUT</span><span class="p">[</span><span class="n">输出区</span><span class="err">\</span><span class="n">n流式</span><span class="o">+</span><span class="n">工具观测</span><span class="p">]</span>

<span class="w">    </span><span class="n">EXP</span><span class="p">[</span><span class="n">Expend</span><span class="err">\</span><span class="n">n知识库</span><span class="o">/</span><span class="n">文生图</span><span class="o">/</span><span class="n">TTS</span><span class="o">/</span><span class="n">ASR</span><span class="o">/</span><span class="n">量化</span><span class="p">]</span>

<span class="w">  </span><span class="n">end</span>



<span class="w">  </span><span class="n">subgraph</span><span class="w"> </span><span class="n">Core</span><span class="p">[</span><span class="n">核心逻辑</span><span class="p">]</span>

<span class="w">    </span><span class="n">CFG</span><span class="p">[</span><span class="n">EVA_TEMP</span><span class="w"> </span><span class="n">配置</span><span class="o">/</span><span class="n">历史</span><span class="p">]</span>

<span class="w">    </span><span class="n">XNET</span><span class="p">[</span><span class="n">xNet</span><span class="err">\</span><span class="n">nHTTP</span><span class="o">+</span><span class="n">SSE</span><span class="p">]</span>

<span class="w">    </span><span class="n">XTOOL</span><span class="p">[</span><span class="n">xTool</span><span class="err">\</span><span class="n">n工具调度</span><span class="p">]</span>

<span class="w">    </span><span class="n">XMCP</span><span class="p">[</span><span class="n">xMcp</span><span class="err">\</span><span class="n">nMCP</span><span class="w"> </span><span class="n">客户端</span><span class="p">]</span>

<span class="w">    </span><span class="n">LSM</span><span class="p">[</span><span class="n">LocalServerManager</span><span class="err">\</span><span class="n">nllama</span><span class="o">-</span><span class="n">server</span><span class="w"> </span><span class="n">托管</span><span class="p">]</span>

<span class="w">  </span><span class="n">end</span>



<span class="w">  </span><span class="n">subgraph</span><span class="w"> </span><span class="n">Backend</span><span class="p">[</span><span class="n">后端</span><span class="p">]</span>

<span class="w">    </span><span class="n">LLS</span><span class="p">[</span><span class="n">llama</span><span class="p">.</span><span class="n">cpp</span><span class="w"> </span><span class="n">server</span><span class="p">]</span>

<span class="w">    </span><span class="n">EMB</span><span class="p">[</span><span class="n">embedding</span><span class="w"> </span><span class="n">server</span><span class="p">]</span>

<span class="w">    </span><span class="n">SD</span><span class="p">[</span><span class="n">stable</span><span class="w"> </span><span class="n">diffusion</span><span class="o">/</span><span class="n">flux</span><span class="p">]</span>

<span class="w">    </span><span class="n">WSP</span><span class="p">[</span><span class="n">whisper</span><span class="o">-</span><span class="n">cli</span><span class="p">]</span>

<span class="w">    </span><span class="n">TTS</span><span class="p">[</span><span class="n">OuteTTS</span><span class="p">]</span>

<span class="w">  </span><span class="n">end</span>



<span class="w">  </span><span class="n">INP</span><span class="w"> </span><span class="o">--&gt;|</span><span class="n">构造消息</span><span class="o">|</span><span class="w"> </span><span class="n">XNET</span>

<span class="w">  </span><span class="n">BTN</span><span class="w"> </span><span class="o">--&gt;</span><span class="w"> </span><span class="n">UI</span>

<span class="w">  </span><span class="n">UI</span><span class="w"> </span><span class="o">--&gt;|</span><span class="n">注入系统指令</span><span class="o">|</span><span class="w"> </span><span class="n">XNET</span>

<span class="w">  </span><span class="n">XNET</span><span class="w"> </span><span class="o">--&gt;|</span><span class="n">SSE</span><span class="w"> </span><span class="n">流</span><span class="o">|</span><span class="w"> </span><span class="n">OUT</span>

<span class="w">  </span><span class="n">OUT</span><span class="w"> </span><span class="o">--&gt;|</span><span class="n">解析</span><span class="w"> </span><span class="o">&lt;</span><span class="n">tool_call</span><span class="o">&gt;|</span><span class="w"> </span><span class="n">XTOOL</span>

<span class="w">  </span><span class="n">XTOOL</span><span class="w"> </span><span class="o">--&gt;|</span><span class="n">内置工具</span><span class="o">|</span><span class="w"> </span><span class="n">EXP</span>

<span class="w">  </span><span class="n">XTOOL</span><span class="w"> </span><span class="o">--&gt;|</span><span class="n">MCP</span><span class="w"> </span><span class="n">工具</span><span class="o">|</span><span class="w"> </span><span class="n">XMCP</span>

<span class="w">  </span><span class="n">XMCP</span><span class="w"> </span><span class="o">--&gt;|</span><span class="n">外部服务</span><span class="o">|</span><span class="w"> </span><span class="n">Backend</span>

<span class="w">  </span><span class="n">UI</span><span class="w"> </span><span class="o">--&gt;|</span><span class="n">本地模式</span><span class="o">|</span><span class="w"> </span><span class="n">LSM</span><span class="w"> </span><span class="o">--&gt;</span><span class="w"> </span><span class="n">LLS</span>

<span class="w">  </span><span class="n">XNET</span><span class="w"> </span><span class="o">--&gt;|</span><span class="n">本地端点</span><span class="o">|</span><span class="w"> </span><span class="n">LLS</span>

<span class="w">  </span><span class="n">EXP</span><span class="w"> </span><span class="o">--&gt;</span><span class="w"> </span><span class="n">Backend</span>

<span class="w">  </span><span class="n">CFG</span><span class="w"> </span><span class="o">&lt;--&gt;</span><span class="w"> </span><span class="n">UI</span>
</code></pre></div>

<h3 id="41">4.1 组件职责<a class="headerlink" href="#41" title="Permanent link">&para;</a></h3>
<ul>
<li>
<p><strong>widget</strong>：主窗口，负责 UI 状态机、快捷键、历史持久化、工程师终端、按钮逻辑。</p>
</li>
<li>
<p><strong>expend</strong>：增殖窗口，承载知识库、模型信息、评估、量化、文生图、语音能力，托管外部进程。</p>
</li>
<li>
<p><strong>xNet</strong>：统一 OpenAI 兼容请求，管理 HTTP + SSE，统计首包、生成速度、timings。</p>
</li>
<li>
<p><strong>xTool</strong>：解析模型 <code>&lt;tool_call&gt;</code>，调度内置工具、工程师工具、MCP 工具；推送终端输出。</p>
</li>
<li>
<p><strong>xMcp</strong>：MCP 客户端，实现 SSE/stdio 通道管理，与 xTool 交互。</p>
</li>
<li>
<p><strong>LocalServerManager</strong>：本地 llama.cpp server 托管，负责启动、重启、日志转发、状态感知。</p>
</li>
</ul>
<h3 id="42">4.2 中央教条<a class="headerlink" href="#42" title="Permanent link">&para;</a></h3>
<ul>
<li>
<p>所有推理均通过 HTTP 完成，本地模式也视作访问本地 server。</p>
</li>
<li>
<p>四大类应当职责清晰，可独立演进但保持协同。</p>
</li>
<li>
<p>约定框架由开发者提供拘束器、工具与约定指令，模型通过 <code>&lt;tool_call&gt;{json}&lt;/tool_call&gt;</code> 驱动受控行为，用户决定启用的工具。</p>
</li>
<li>
<p>工程师上下文：UI 在装载后注入 <code>ENGINEER_INFO</code>，包含 OS、日期、默认 Shell/Python、工程师工作目录、<code>EVA_WORK</code> 两层目录快照，约束模型仅在指定根目录行动。</p>
</li>
<li>
<p>“朗基努斯之枪（残酷的现实）”是最高校准原则：关键决策必须由可验证证据驱动（工具回执、测试结果、运行日志、用户验收），不能被模型主观叙事替代。</p>
</li>
</ul>
<h2 id="5">5. 运行模式与状态<a class="headerlink" href="#5" title="Permanent link">&para;</a></h2>
<h3 id="51">5.1 模式与状态<a class="headerlink" href="#51" title="Permanent link">&para;</a></h3>
<ul>
<li>
<p><strong>对话模式</strong>：多轮聊天，支持文本、图片、音频及工具链。</p>
</li>
<li>
<p><strong>补完模式</strong>：将输出区作为 prompt，一次性补全。</p>
</li>
<li>
<p><strong>本地模式</strong>：托管 llama.cpp server，自动切换本地端点。</p>
</li>
<li>
<p><strong>链接模式</strong>：使用远端 endpoint/key/model，停用本地服务。</p>
</li>
</ul>
<h3 id="52-ui">5.2 UI 状态机<a class="headerlink" href="#52-ui" title="Permanent link">&para;</a></h3>
<div class="codehilite"><pre><span></span><code><span class="n">stateDiagram</span><span class="o">-</span><span class="n">v2</span>

<span class="w">  </span><span class="p">[</span><span class="o">*</span><span class="p">]</span><span class="w"> </span><span class="o">--&gt;</span><span class="w"> </span><span class="err">未装载</span>

<span class="w">  </span><span class="err">未装载</span><span class="w"> </span><span class="o">--&gt;</span><span class="w"> </span><span class="err">装载中</span><span class="o">:</span><span class="w"> </span><span class="err">点击装载</span>

<span class="w">  </span><span class="err">装载中</span><span class="w"> </span><span class="o">--&gt;</span><span class="w"> </span><span class="err">正常</span><span class="o">:</span><span class="w"> </span><span class="err">本地</span><span class="w"> </span><span class="n">server</span><span class="w"> </span><span class="n">ready</span><span class="err">\</span><span class="n">n或远端配置就绪</span>

<span class="w">  </span><span class="err">正常</span><span class="w"> </span><span class="o">--&gt;</span><span class="w"> </span><span class="err">推理中</span><span class="o">:</span><span class="w"> </span><span class="err">点击发送</span>

<span class="w">  </span><span class="err">推理中</span><span class="w"> </span><span class="o">--&gt;</span><span class="w"> </span><span class="err">正常</span><span class="o">:</span><span class="w"> </span><span class="n">SSE</span><span class="w"> </span><span class="err">完成</span><span class="o">/</span><span class="err">工具链结束</span>

<span class="w">  </span><span class="err">正常</span><span class="w"> </span><span class="o">--&gt;</span><span class="w"> </span><span class="err">录音中</span><span class="o">:</span><span class="w"> </span><span class="n">F2</span><span class="w"> </span><span class="err">开始</span><span class="o">/</span><span class="err">结束录音</span>

<span class="w">  </span><span class="err">正常</span><span class="w"> </span><span class="o">--&gt;</span><span class="w"> </span><span class="err">未装载</span><span class="o">:</span><span class="w"> </span><span class="err">重置两次（终止</span><span class="o">-&gt;</span><span class="err">清空）</span>
</code></pre></div>

<p>按钮与可用性：</p>
<ul>
<li>
<p><strong>装载</strong>：装载前唯一可用；装载中全禁；正常时全可用；推理中仅重置可用。</p>
</li>
<li>
<p><strong>约定</strong>：编辑系统提示词、昵称、工具开关，确认后重置上下文。</p>
</li>
<li>
<p><strong>设置</strong>：采样参数即时生效；涉及模型/设备/nctx/ngl/lora/mmproj/并发/批/端口时，会重启本地 server。</p>
</li>
<li>
<p><strong>重置</strong>：首次终止当前回合，再次清空对话并新建会话。</p>
</li>
<li>
<p><strong>发送</strong>：组装消息发送给 xNet，接收 SSE 并驱动工具循环。</p>
</li>
</ul>
<h3 id="53-ui">5.3 UI 辅助元素<a class="headerlink" href="#53-ui" title="Permanent link">&para;</a></h3>
<ul>
<li>
<p><strong>快捷键</strong>：F1 截图、F2 录音、Ctrl+Enter 发送、TerminalPane 内 Ctrl+C 中断命令。</p>
</li>
<li>
<p><strong>记录条 / RecordBar</strong>：输出区与输入区之间的色块时间线（system/user/assistant/think/tool），悬停提示、单击定位、双击编辑并同步历史。</p>
</li>
<li>
<p><strong>TerminalPane</strong>：状态区右侧的终端面板，显示工程师工具与 MCP 命令的 stdout/stderr，工具执行时自动展开，可 Stop 或 Ctrl+C 中断，支持手动输入命令（使用当前工程师工作目录）。</p>
</li>
<li>
<p><strong>KV 进度条</strong>：顶部双进度条实时展示 prompt 与生成占用，链接模式缺口时以 <code>usage.prompt_tokens</code> 兜底。</p>
</li>
<li>
<p><strong>系统托盘</strong>：提供“显示主窗”“显示增殖”“触发截图”“退出”等入口，隐藏窗口时仍可唤回。</p>
</li>
<li>
<p><strong>工程师工作目录</strong>：默认 <code>EVA_WORK</code>（应用同级），可在约定面板修改；修改后刷新 TerminalPane、工具及提示词上下文。</p>
</li>
</ul>
<h2 id="6">6. 核心工作流<a class="headerlink" href="#6" title="Permanent link">&para;</a></h2>
<h3 id="61">6.1 本地装载流程<a class="headerlink" href="#61" title="Permanent link">&para;</a></h3>
<div class="codehilite"><pre><span></span><code><span class="n">flowchart</span><span class="w"> </span><span class="n">TD</span>

<span class="w">  </span><span class="n">A</span><span class="p">[</span><span class="err">装载</span><span class="p">]</span><span class="w"> </span><span class="o">--&gt;</span><span class="w"> </span><span class="n">B</span><span class="p">{</span><span class="err">选择模式</span><span class="p">}</span>

<span class="w">  </span><span class="n">B</span><span class="w"> </span><span class="o">--&gt;|</span><span class="err">本地</span><span class="o">|</span><span class="w"> </span><span class="n">C</span><span class="p">[</span><span class="err">选择</span><span class="w"> </span><span class="n">gguf</span><span class="w"> </span><span class="err">模型</span><span class="p">]</span>

<span class="w">  </span><span class="n">C</span><span class="w"> </span><span class="o">--&gt;</span><span class="w"> </span><span class="n">D</span><span class="p">[</span><span class="err">进入装载中\</span><span class="n">n清屏</span><span class="o">/</span><span class="err">锁定</span><span class="o">/</span><span class="err">转轮</span><span class="p">]</span>

<span class="w">  </span><span class="n">D</span><span class="w"> </span><span class="o">--&gt;</span><span class="w"> </span><span class="n">E</span><span class="p">[</span><span class="err">按设置启动</span><span class="o">/</span><span class="err">重启</span><span class="w"> </span><span class="n">llama</span><span class="o">-</span><span class="n">server</span><span class="p">]</span>

<span class="w">  </span><span class="n">E</span><span class="w"> </span><span class="o">--&gt;</span><span class="w"> </span><span class="n">F</span><span class="p">{</span><span class="err">监听</span><span class="w"> </span><span class="n">ready</span><span class="w"> </span><span class="err">日志</span><span class="o">?</span><span class="p">}</span>

<span class="w">  </span><span class="n">F</span><span class="w"> </span><span class="o">--&gt;|</span><span class="err">失败</span><span class="o">|</span><span class="w"> </span><span class="n">E</span>

<span class="w">  </span><span class="n">F</span><span class="w"> </span><span class="o">--&gt;|</span><span class="err">成功</span><span class="o">|</span><span class="w"> </span><span class="n">G</span><span class="p">[</span><span class="err">切换本地端点\</span><span class="n">n注入系统指令</span><span class="err">\</span><span class="n">n新建会话</span><span class="p">]</span>

<span class="w">  </span><span class="n">G</span><span class="w"> </span><span class="o">--&gt;</span><span class="w"> </span><span class="n">H</span><span class="p">[</span><span class="err">解锁\</span><span class="n">n可聊天</span><span class="p">]</span>
</code></pre></div>

<p>启动细节：</p>
<ul>
<li>
<p>根据设备选择自动估算 GPU offload（ngl），装载后以 <code>n_layer+1</code> 校准。</p>
</li>
<li>
<p>若配置缺省，自动从 <code>EVA_MODELS</code> 选择最小的 gguf 模型、embedding、whisper、tts.cpp、sd1.5-anything-3。</p>
</li>
<li>
<p>本地 server stdout/stderr 传入增殖窗口“模型日志”。</p>
</li>
</ul>
<h3 id="62">6.2 链接模式装载<a class="headerlink" href="#62" title="Permanent link">&para;</a></h3>
<div class="codehilite"><pre><span></span><code><span class="n">flowchart</span><span class="w"> </span><span class="n">TD</span>

<span class="w">  </span><span class="n">A</span><span class="p">[</span><span class="err">装载</span><span class="p">]</span><span class="w"> </span><span class="o">--&gt;</span><span class="w"> </span><span class="n">B</span><span class="p">{</span><span class="err">选择模式</span><span class="p">}</span>

<span class="w">  </span><span class="n">B</span><span class="w"> </span><span class="o">--&gt;|</span><span class="err">链接</span><span class="o">|</span><span class="w"> </span><span class="n">C</span><span class="p">[</span><span class="err">填写</span><span class="w"> </span><span class="kd">endp</span><span class="n">oint</span><span class="o">/</span><span class="n">key</span><span class="o">/</span><span class="n">model</span><span class="p">]</span>

<span class="w">  </span><span class="n">C</span><span class="w"> </span><span class="o">--&gt;</span><span class="w"> </span><span class="n">D</span><span class="p">[</span><span class="err">切换远端模式\</span><span class="n">n停止本地服务</span><span class="o">/</span><span class="err">在途请求</span><span class="p">]</span>

<span class="w">  </span><span class="n">D</span><span class="w"> </span><span class="o">--&gt;</span><span class="w"> </span><span class="n">E</span><span class="p">[</span><span class="err">清屏\</span><span class="n">n注入系统指令</span><span class="p">]</span>

<span class="w">  </span><span class="n">E</span><span class="w"> </span><span class="o">--&gt;</span><span class="w"> </span><span class="n">F</span><span class="p">[</span><span class="err">解锁\</span><span class="n">n可聊天</span><span class="p">]</span>
</code></pre></div>

<h3 id="63">6.3 发送 / 推理流程<a class="headerlink" href="#63" title="Permanent link">&para;</a></h3>
<ul>
<li>
<p><code>widget</code> 组装 OpenAI 兼容 <code>messages</code>（含 system + user，可包含 <code>text/image_url/input_audio</code>）。</p>
</li>
<li>
<p><code>xNet</code> 创建请求体，建立 HTTP 连接，解析 SSE 分块。</p>
</li>
<li>
<p><code>&lt;think&gt; .. &lt;/think&gt;</code> 用于渲染推理思考区域；<code>xNet</code> 统计 reasoning tokens。</p>
</li>
<li>
<p><code>&lt;tool_call&gt;{json}&lt;/tool_call&gt;</code> 触发工具调用，SSE 在关闭前保留以等待 usage/timings。</p>
</li>
</ul>
<h3 id="64">6.4 工具循环<a class="headerlink" href="#64" title="Permanent link">&para;</a></h3>
<div class="codehilite"><pre><span></span><code><span class="n">sequenceDiagram</span>

<span class="w">  </span><span class="n">participant</span><span class="w"> </span><span class="n">UI</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">Widget</span>

<span class="w">  </span><span class="n">participant</span><span class="w"> </span><span class="n">NET</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">xNet</span>

<span class="w">  </span><span class="n">participant</span><span class="w"> </span><span class="n">LLM</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="err">本地</span><span class="o">/</span><span class="err">远端</span><span class="w"> </span><span class="n">LLM</span>

<span class="w">  </span><span class="n">participant</span><span class="w"> </span><span class="n">TOOL</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">xTool</span>

<span class="w">  </span><span class="n">participant</span><span class="w"> </span><span class="n">EXT</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="err">扩展</span><span class="o">/</span><span class="err">外部服务</span>



<span class="w">  </span><span class="n">UI</span><span class="o">-&gt;&gt;</span><span class="n">NET</span><span class="p">:</span><span class="w"> </span><span class="n">system</span><span class="o">+</span><span class="n">user</span><span class="w"> </span><span class="err">消息</span>

<span class="w">  </span><span class="n">NET</span><span class="o">-&gt;&gt;</span><span class="n">LLM</span><span class="p">:</span><span class="w"> </span><span class="n">HTTP</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">SSE</span>

<span class="w">  </span><span class="n">LLM</span><span class="o">--&gt;&gt;</span><span class="n">NET</span><span class="p">:</span><span class="w"> </span><span class="err">流式</span><span class="w"> </span><span class="n">tokens</span><span class="err">（含</span><span class="w"> </span><span class="o">&lt;</span><span class="n">think</span><span class="o">&gt;/&lt;</span><span class="n">tool_call</span><span class="o">&gt;</span><span class="err">）</span>

<span class="w">  </span><span class="n">NET</span><span class="o">--&gt;&gt;</span><span class="n">UI</span><span class="p">:</span><span class="w"> </span><span class="err">渲染输出</span>

<span class="w">  </span><span class="n">UI</span><span class="o">-&gt;&gt;</span><span class="n">TOOL</span><span class="p">:</span><span class="w"> </span><span class="err">解析</span><span class="w"> </span><span class="n">JSON</span><span class="w"> </span><span class="p">{</span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="n">arguments</span><span class="p">}</span>

<span class="w">  </span><span class="n">TOOL</span><span class="o">-&gt;&gt;</span><span class="n">EXT</span><span class="p">:</span><span class="w"> </span><span class="err">执行工具（计算</span><span class="o">/</span><span class="err">检索</span><span class="o">/</span><span class="err">命令</span><span class="o">/</span><span class="n">MCP</span><span class="o">/</span><span class="err">鼠键等）</span>

<span class="w">  </span><span class="n">EXT</span><span class="o">--&gt;&gt;</span><span class="n">TOOL</span><span class="p">:</span><span class="w"> </span><span class="err">结果文本</span><span class="o">/</span><span class="err">图片</span><span class="o">/</span><span class="n">JSON</span>

<span class="w">  </span><span class="n">TOOL</span><span class="o">--&gt;&gt;</span><span class="n">UI</span><span class="p">:</span><span class="w"> </span><span class="n">append</span><span class="w"> </span><span class="n">role</span><span class="o">=</span><span class="k">tool</span><span class="p">,</span><span class="w"> </span><span class="n">content</span><span class="o">=</span><span class="s2">&quot;tool_response: ...&quot;</span>

<span class="w">  </span><span class="n">UI</span><span class="o">-&gt;&gt;</span><span class="n">NET</span><span class="p">:</span><span class="w"> </span><span class="err">自动继续发送最新上下文</span>

<span class="w">  </span><span class="n">NET</span><span class="o">--&gt;&gt;</span><span class="n">UI</span><span class="p">:</span><span class="w"> </span><span class="err">最终答复或下一轮工具</span>
</code></pre></div>

<h3 id="65">6.5 多模态输入<a class="headerlink" href="#65" title="Permanent link">&para;</a></h3>
<ul>
<li>
<p><strong>图像</strong>：拖拽、上传或 F1 截图，作为 <code>image_url</code> 附在 user 消息（支持多图）。</p>
</li>
<li>
<p><strong>音频</strong>：上传 WAV/MP3/OGG/FLAC；发送前转换为 OpenAI <code>input_audio</code>。</p>
</li>
<li>
<p><strong>F2 录音转写</strong>：第一次选择 whisper 模型；再次 F2 录音，结束后自动调用 whisper-cli，结果回填输入框。</p>
</li>
</ul>
<h3 id="66">6.6 自动弹出（惰性卸载）<a class="headerlink" href="#66" title="Permanent link">&para;</a></h3>
<ul>
<li>
<p><strong>目标</strong>：在本地模式长时间运行时按需释放 llama.cpp 占用的显存与算力，同时保持 UI 状态与会话上下文不丢失。</p>
</li>
<li>
<p><strong>计时器与激活条件</strong>：当 <code>lazy_unload_minutes</code> 大于 0 且模式为本地时，<code>Widget::scheduleLazyUnload()</code> 会在后端就绪、推理或工具链结束后启动单次计时器；<code>markBackendActivity()</code> 在用户输入、SSE 流、工具响应及代理流量到达时重置倒计时，确保活跃会话不会被卸载。</p>
</li>
<li>
<p><strong>倒计时与交互</strong>：设置面板显示“弹出倒计时”标签，由 <code>lazyCountdownTimer_</code> 每秒刷新剩余时间；右键该标签触发 <code>onLazyUnloadNowClicked()</code> 可立即弹出；将倒计时设为 0 即可禁用惰性卸载，配置持久化在 <code>EVA_TEMP/eva_config.ini</code> 的 <code>lazy_unload_minutes</code> 字段。</p>
</li>
<li>
<p><strong>执行阶段</strong>：计时到期时 <code>performLazyUnloadInternal(false)</code> 异步停止 <code>llama-server</code>，保留状态区日志（<code>lazyUnloadPreserveState_</code>）并输出 <code>auto eject stop backend</code>、<code>auto eject sleeping</code> 提示；本地代理 <code>LocalProxyServer</code> 继续占用前端端口，对新 HTTP 请求返回 503，同时记录访问来源。</p>
</li>
<li>
<p><strong>唤醒流程</strong>：指挥员再次发送消息或外部客户端访问端口时，代理触发 <code>wakeRequested</code>，UI 提示“正在唤醒本地后端”，通过 <code>ensureLocalServer(true)</code> 重启 llama.cpp；若发送发生在休眠期间，<code>pendingSendAfterWake_</code> 会在后端就绪后自动补发请求并重新开启倒计时。</p>
</li>
</ul>
<h3 id="67">6.7 本地代理实现<a class="headerlink" href="#67" title="Permanent link">&para;</a></h3>
<ul>
<li>
<p><strong>设计目标</strong>：<code>LocalProxyServer</code> 充当 UI/第三方客户端与 llama-server 之间的缓冲层，保持前端端口常驻、屏蔽后端重启细节，并在惰性卸载时准确捕获外部访问信号触发唤醒。</p>
</li>
<li>
<p><strong>监听与会话</strong>：代理内部持有一个 <code>QTcpServer</code>，监听 UI 绑定的“前端端口”。每次 <code>newConnection</code> 都实例化 <code>ProxySession</code>，该会话维护到客户端和后端的 <code>QTcpSocket</code>，并以 <code>LowDelayOption</code> 降低转发时延。</p>
</li>
<li>
<p><strong>后端通道管理</strong>：<code>ProxySession::setBackendEndpoint()</code> 跟随 UI 更新后端地址；<code>start(backendReady)</code> 决定立即连后端或等待。后端未就绪时，会话记录请求数据，开启 30 秒等待定时器，并加入 <code>pendingSessions_</code> 等待唤醒。</p>
</li>
<li>
<p><strong>唤醒机制</strong>：代理维护 <code>backendReady_</code> 标记。若未就绪且收到新的客户端连接，将触发 <code>wakeRequested</code> 信号；Widget 槽函数调用 <code>ensureLocalServer(true)</code> 拉起 llama-server，同时用 <code>externalActivity</code> 通知 UI 更新惰性卸载倒计时。</p>
</li>
<li>
<p><strong>数据转发与故障</strong>：后端连通后，<code>flushPendingClientData()</code> 把缓存请求回放到 llama-server，并在后续直接转发双向数据。当后端断开、超时或连接失败时，会话构造 JSON 体的 503 响应并关闭连接，确保调用方得到明确反馈。</p>
</li>
<li>
<p><strong>状态同步</strong>：Widget 根据 <code>LocalServerManager</code> 的回调调用 <code>setBackendAvailable(true/false)</code>，驱动代理把挂起会话切换为正式连接或重新排队；<code>shutdownSessions()</code> 用于应用退出或端口重绑场景的快速清理。</p>
</li>
<li>
<p><strong>端口保持</strong>：即便后端惰性卸载，代理依旧占有前端端口，外部工具不会感知短暂的后端消失；恢复时仅需恢复 TCP 隧道即可，避免窗口提示“端口被占用”或客户端重连失败。</p>
</li>
</ul>
<h2 id="7">7. 工具体系与安全<a class="headerlink" href="#7" title="Permanent link">&para;</a></h2>
<h3 id="71">7.1 内置工具<a class="headerlink" href="#71" title="Permanent link">&para;</a></h3>
<p>| 名称 | 作用 |</p>
<p>| --- | --- |</p>
<p>| <code>answer(content)</code> | 最终答复用户。 |</p>
<p>| <code>calculator(expression)</code> | 表达式计算（tinyexpr）。 |</p>
<p>| <code>execute_command(content)</code> | 在工程师工作目录执行命令，输出 stdout/stderr。 |</p>
<p>| ptc(filename, workdir, content) | Programmatic Tool Calling：将 Python 源码写入工作区 ptc_temp/<filename> 并在 workdir 内执行，stdout/stderr 都会写入工具响应。 |</p>
<p>| <code>knowledge(query, top_n, filters?)</code> | 向量检索返回 Top-N 文本片段。 |</p>
<p>| <code>controller(sequence)</code> | 桌面控制器编排，执行后返回截图。 |</p>
<p>| <code>list_files/search_content/read_file/write_file/replace_in_file/edit_in_file</code> | 文件读写与检索。 |</p>
<p>| <code>stablediffusion(args)</code> | 文生图，返回带标记的图片路径。 |</p>
<h3 id="72-mcp">7.2 MCP 集成<a class="headerlink" href="#72-mcp" title="Permanent link">&para;</a></h3>
<p>| 维度 | 说明 |</p>
<p>| --- | --- |</p>
<p>| <strong>配置入口</strong> | 增殖「MCP 服务」面板，读取/写入 <code>EVA_TEMP/mcp_servers.json</code>，UI 支持上传 JSON、手动增删、批量启用。 |</p>
<p>| <strong>传输协议</strong> | - <code>streamableHttp</code>：HTTP POST + 可选 GET <code>text/event-stream</code>，自动保存 <code>Mcp-Session-Id</code>，当服务器拒绝 GET(405) 时退化为响应内推流。<br>- <code>sse</code>：两段式（GET 建立 SSE 流 + POST 消息端点），支持服务端 <code>endpoint</code> 事件动态改写消息地址。<br>- <code>stdio</code>：通过 <code>QProcess</code> 启动外部可执行文件（llama.cpp、Python server 等），使用换行 JSON 双向通信。 |</p>
<p>| <strong>配置字段</strong> | 通用字段：<code>name</code>、<code>description</code>、<code>isActive</code>、<code>headers</code>、<code>env</code>、<code>clientName</code>/<code>clientVersion</code>。<br><code>streamableHttp|sse</code> 需要 <code>baseUrl</code>（必要时附带 <code>sseEndpoint</code>），<code>stdio</code> 需要 <code>command</code>+<code>args</code>。<br>为兼容外部导入，<code>type</code> 支持 <code>sse</code> / <code>streamableHttp</code> / <code>http</code> / <code>stdio</code>，旧版 <code>url</code> 自动映射到 <code>baseUrl</code>。 |</p>
<p>| <strong>挂载流程</strong> | 1. 用户在面板勾选服务；2. <code>Expend</code> 通过 <code>expend2mcp_addService</code> 下发；3. <code>McpToolManager::addServer</code> 解析配置、构造客户端并调用 <code>initialize</code>；4. 成功后缓存 <code>listTools</code> 结果并通过 <code>expend2ui_mcpToolsChanged</code> 反馈 UI。 |</p>
<p>| <strong>工具路由</strong> | xTool 收到模型 <code>&lt;tool_call name="service@tool"&gt;</code> 后分离服务名与工具名，调用 <code>McpToolManager::callTool</code>，其内部会自动重试、捕获 JSON-RPC 错误，并把结果封装为 <code>tool_response: ...</code> 追加到对话。 |</p>
<p>| <strong>通知/进度</strong> | - SSE/Streamable HTTP：若服务器提供 GET SSE，则实时触发 <code>serverNotificationReceived</code>/<code>serverMessageReceived</code>，UI 状态区同步展示。<br>- Streamable HTTP 在服务端拒绝 GET 时，会退化为解析 POST 响应中的 <code>text/event-stream</code> 块，仍能获取本次调用的进度。<br>- stdio：依靠子进程 stdout 事件直接推送。 |</p>
<p>| <strong>日志与容错</strong> | 所有客户端都挂接到 <code>qmcp.xxx</code> 日志域，终端右侧终端面板会显示初始化、SSE 断线、工具调用失败等信息；初始化失败会提示“Failed to initialize <type> server”，并继续处理其他服务，避免单点阻塞。 |</p>
<blockquote>
<p>小结：xTool 与 xMcp 之间完全以信号槽隔离，MCP 工具与本地工具在模型视角保持统一接口，便于驾驶员随时切换“外部约定”。</p>
</blockquote>
<h3 id="73">7.3 安全边界<a class="headerlink" href="#73" title="Permanent link">&para;</a></h3>
<ul>
<li>
<p>工程师工作根：所有文件操作、命令执行与终端手动命令均受限于 <code>engineerWorkDir</code>（默认 <code>EVA_WORK</code>），修改后即时持久化并同步终端。</p>
</li>
<li>
<p>高风险工具（如 <code>controller</code>、<code>execute_command</code>）默认关闭，需要用户在约定面板显式启用。</p>
</li>
<li>
<p>输出、工具观测、历史记录均持久化，敏感信息需谨慎处理。</p>
</li>
<li>
<p>TerminalPane 由 <code>tool2ui_terminal*</code> 信号驱动，记录命令开始、输出、结束；手动命令通过 <code>cmd /c</code>（Windows）或 <code>/bin/sh -lc</code>（Linux）执行，可使用 Stop 中断。</p>
</li>
</ul>
<h3 id="74">7.4 工具调用流程图<a class="headerlink" href="#74" title="Permanent link">&para;</a></h3>
<div class="codehilite"><pre><span></span><code><span class="n">flowchart</span><span class="w"> </span><span class="n">LR</span>

<span class="w">  </span><span class="n">P</span><span class="p">[</span><span class="err">解析</span><span class="w"> </span><span class="o">&lt;</span><span class="n">tool_call</span><span class="o">&gt;</span><span class="p">]</span><span class="o">--&gt;</span><span class="n">Q</span><span class="p">{</span><span class="n">name</span><span class="p">}</span>

<span class="w">  </span><span class="n">Q</span><span class="w"> </span><span class="o">--&gt;|</span><span class="n">answer</span><span class="o">|</span><span class="w"> </span><span class="n">R</span><span class="p">[</span><span class="err">结束回合</span><span class="p">]</span>

<span class="w">  </span><span class="n">Q</span><span class="w"> </span><span class="o">--&gt;|</span><span class="err">内置</span><span class="o">|</span><span class="w"> </span><span class="n">S</span><span class="p">[</span><span class="err">执行工具</span><span class="p">]</span>

<span class="w">  </span><span class="n">Q</span><span class="w"> </span><span class="o">--&gt;|</span><span class="n">MCP</span><span class="o">|</span><span class="w"> </span><span class="n">T</span><span class="p">[</span><span class="err">转发</span><span class="w"> </span><span class="n">MCP</span><span class="w"> </span><span class="err">服务</span><span class="p">]</span>

<span class="w">  </span><span class="n">S</span><span class="w"> </span><span class="o">--&gt;</span><span class="w"> </span><span class="n">U</span><span class="p">[</span><span class="n">tool_response</span><span class="w"> </span><span class="err">回注</span><span class="p">]</span>

<span class="w">  </span><span class="n">T</span><span class="w"> </span><span class="o">--&gt;</span><span class="w"> </span><span class="n">U</span>

<span class="w">  </span><span class="n">U</span><span class="w"> </span><span class="o">--&gt;</span><span class="w"> </span><span class="n">V</span><span class="p">[</span><span class="err">自动再次发送上下文</span><span class="p">]</span>
</code></pre></div>

<h3 id="75">7.5 技能系统整合<a class="headerlink" href="#75" title="Permanent link">&para;</a></h3>
<p>技能（Skill）为 EVA 在约定框架下引入的可插拔能力包，规范与实现均对齐参考项目 <code>参考项目/skills-main</code> 中的 Agent Skills 体系。通过该机制，指挥员可在不改动主程序的情况下，为“驾驶员”注入特定场景的流程、模板与脚本指令。</p>
<ul>
<li>
<p><strong>规范约束</strong>：<code>skills-main/agent_skills_spec.md</code> 定义了技能的语义与协作流程。每个技能都必须提供 <code>SKILL.md</code>，文件以 YAML frontmatter 描述 <code>name</code>、<code>description</code>、<code>license</code> 等元数据，正文给出操作步骤、输入输出格式、注意事项。EVA 在解析时严格依赖这些字段，缺失将直接拒绝导入。</p>
</li>
<li>
<p><strong>包结构与导入</strong>：技能以压缩包分发，根目录持有 <code>SKILL.md</code>、可选的 <code>assets/</code>、<code>scripts/</code>、<code>README.md</code> 等资源。拖拽 <code>.zip</code> 至 UI 的技能坠落区（<code>src/widget/skill_drop_area.*</code>）后，<code>SkillManager::importSkillArchiveAsync</code> 会调用 <code>zip::extractArchive</code> 临时解包，查找 <code>SKILL.md</code>，并将内容复制到应用目录下的 <code>EVA_SKILLS/&lt;skill-id&gt;</code>。若目标目录已存在，则先安全删除旧版本，再写入新版。</p>
</li>
<li>
<p><strong>扫描与持久化</strong>：<code>SkillManager::loadFromDisk</code> 启动时遍历 <code>EVA_SKILLS</code> 与内置的 <code>bundled_skills</code>（<code>src/skill/skill_manager.cpp</code>），解析 frontmatter 并生成 <code>SkillRecord</code> 列表，指挥员上次勾选的启用状态会通过 <code>restoreEnabledSet</code> 还原。右键可移除技能，操作将递归删除对应目录。</p>
</li>
<li>
<p><strong>提示块注入</strong>：当系统工程师工具链激活时，<code>SkillManager::composePromptBlock</code> 会插入“[Skill Usage Protocol]”提示块到系统指令，明确要求模型在调用技能前使用 <code>read_file</code> 拉取 <code>SKILL.md</code>、在 <code>execute_command</code> 中运行脚本，并始终将产物写回工程工作目录。这段提示会根据运行环境列出宿主或容器中的绝对路径（Docker 下展示 <code>/eva_workspace</code>、<code>/eva_skills</code>），便于驾驶员精确定位资源。</p>
</li>
<li>
<p><strong>运行期协作</strong>：模型若在对话中引用技能指令，将根据技能文档与挂载的工具（如 <code>execute_command</code>、<code>knowledge</code>）组合行动。技能脚本默认以工程工作目录（<code>engineerWorkDir</code>）为根，防止越权访问；所有执行回执通过工具响应写入对话，形成可追溯的“技能调用→工具反馈→继续推理”循环。</p>
</li>
</ul>
<h2 id="8">8. 增殖能力总览<a class="headerlink" href="#8" title="Permanent link">&para;</a></h2>
<h3 id="81">8.1 知识库<a class="headerlink" href="#81" title="Permanent link">&para;</a></h3>
<ul>
<li>
<p>构建：选择嵌入模型 → 启动 embedding server（<code>/v1/embeddings</code>） → 上传/编辑文本 → 切分段落 → 获取向量 → 入库。</p>
</li>
<li>
<p>检索：xTool 计算查询向量，与本地向量库求余弦相似度，返回 Top-N。</p>
</li>
<li>
<p>自动托管：若已有持久化向量库或勾选嵌入服务需求，启动阶段自动拉起 llama.cpp embedding server，关闭应用时安全终止。</p>
</li>
</ul>
<div class="codehilite"><pre><span></span><code><span class="n">flowchart</span><span class="w"> </span><span class="n">TD</span>

<span class="w">  </span><span class="n">A</span><span class="p">[</span><span class="err">选择嵌入模型</span><span class="p">]</span><span class="w"> </span><span class="o">--&gt;</span><span class="w"> </span><span class="n">B</span><span class="p">[</span><span class="err">启动</span><span class="w"> </span><span class="n">embedding</span><span class="w"> </span><span class="n">server</span><span class="p">]</span>

<span class="w">  </span><span class="n">B</span><span class="w"> </span><span class="o">--&gt;</span><span class="w"> </span><span class="n">C</span><span class="p">[</span><span class="err">上传</span><span class="o">/</span><span class="err">编辑文本</span><span class="p">]</span>

<span class="w">  </span><span class="n">C</span><span class="w"> </span><span class="o">--&gt;</span><span class="w"> </span><span class="n">D</span><span class="p">[</span><span class="err">段落切分</span><span class="p">]</span>

<span class="w">  </span><span class="n">D</span><span class="w"> </span><span class="o">--&gt;</span><span class="w"> </span><span class="n">E</span><span class="p">[</span><span class="err">调用</span><span class="w"> </span><span class="o">/</span><span class="n">v1</span><span class="o">/</span><span class="n">embeddings</span><span class="p">]</span>

<span class="w">  </span><span class="n">E</span><span class="w"> </span><span class="o">--&gt;</span><span class="w"> </span><span class="n">F</span><span class="p">[</span><span class="err">向量入库</span><span class="p">]</span>

<span class="w">  </span><span class="n">F</span><span class="w"> </span><span class="o">--&gt;</span><span class="w"> </span><span class="n">G</span><span class="p">[</span><span class="err">工具检索返回片段</span><span class="p">]</span>
</code></pre></div>

<h3 id="82">8.2 文生图<a class="headerlink" href="#82" title="Permanent link">&para;</a></h3>
<ul>
<li>
<p>调用 stable diffusion / flux 可执行或脚本。</p>
</li>
<li>
<p>结果通过特殊标记回注，UI 在输出区呈现图片。</p>
</li>
</ul>
<h3 id="83">8.3 声转文 / 文转声<a class="headerlink" href="#83" title="Permanent link">&para;</a></h3>
<ul>
<li>
<p><strong>Whisper</strong>：F2 录音 → whisper-cli → 文本回填。</p>
</li>
<li>
<p><strong>TTS</strong>：tts.cpp，增殖窗口按段播放流式输出。</p>
</li>
</ul>
<h3 id="84">8.4 模型信息与量化<a class="headerlink" href="#84" title="Permanent link">&para;</a></h3>
<ul>
<li>
<p>模型信息：3D 神经元背景日志控件（NeuronLogEdit），懒加载动画节省资源。</p>
</li>
<li>
<p>模型评估：详见第 11 章“观测与评估”。</p>
</li>
<li>
<p>量化与转换：f32/f16/bf16/q8_0 等量化；支持 HF → GGUF 转换脚本。</p>
</li>
</ul>
<h2 id="9">9. 运行时管理<a class="headerlink" href="#9" title="Permanent link">&para;</a></h2>
<h3 id="91">9.1 后端目录约束<a class="headerlink" href="#91" title="Permanent link">&para;</a></h3>
<ul>
<li>
<p>目录结构：<code>EVA_BACKEND/&lt;arch&gt;/&lt;os&gt;/&lt;device&gt;/&lt;project&gt;/&lt;executable&gt;</code>。</p>
</li>
<li>
<p><code>DeviceManager</code> 负责扫描可用 backend（cpu/cuda/vulkan/opencl），支持 <code>auto</code> 选择与回退。</p>
</li>
<li>
<p>支持架构：x86_64 / x86_32 / arm64 / arm32；操作系统：win / win7 / linux / mac。</p>
</li>
<li>
<p><code>programPath()</code> 根据设备排序查找可执行，透传日志帮助诊断。</p>
</li>
</ul>
<h3 id="92-gpu-offload">9.2 GPU offload 策略<a class="headerlink" href="#92-gpu-offload" title="Permanent link">&para;</a></h3>
<ul>
<li>
<p>手动本地装载默认 <code>ngl=999</code> 拉满（不依赖 vfree 探测），装载完成后再按真实 <code>max_ngl</code> 校准。</p>
</li>
<li>
<p>装载后根据后端回传的 <code>max_ngl</code>（n_layer+1）修正展示与滑条上限。</p>
</li>
</ul>
<h3 id="93">9.3 自动目录<a class="headerlink" href="#93" title="Permanent link">&para;</a></h3>
<ul>
<li>
<p><code>EVA_TEMP</code>：配置、历史、临时产物。</p>
</li>
<li>
<p><code>EVA_WORK</code>：默认工程师工作区；首次启动创建，可在约定面板修改。</p>
</li>
<li>
<p>TTS 临时目录：位于 <code>EVA_TEMP/tts</code>，避免污染工作区。</p>
</li>
</ul>
<h2 id="10">10. 配置与持久化<a class="headerlink" href="#10" title="Permanent link">&para;</a></h2>
<ul>
<li>
<p><strong>EVA_TEMP/eva_config.ini</strong>：通过 <code>QSettings</code> 存储模型路径、设备、采样参数、端点、工具开关、工程师工作目录等。首启缺省时自动写入默认模型。</p>
</li>
<li>
<p><strong>工程师系统指令</strong>：<code>ENGINEER_SYSTEM_INFO</code> 注入操作系统、日期、Shell、Python、工作目录、<code>EVA_WORK</code> 目录快照，提醒模型仅在该目录内执行命令。</p>
</li>
<li>
<p><strong>历史会话</strong>：<code>EVA_TEMP/history/&lt;id&gt;/{meta.json,messages.jsonl}</code>，支持右键菜单或增殖窗口打开“历史会话管理”对话框，提供搜索、重命名、删除、清空、双击恢复，操作即时持久化。</p>
</li>
<li>
<p><strong>RecordBar 同步</strong>：历史恢复时重建记录条；双击编辑后写回 <code>messages.jsonl</code>。</p>
</li>
</ul>
<h2 id="11">11. 观测与评估<a class="headerlink" href="#11" title="Permanent link">&para;</a></h2>
<h3 id="111-sse">11.1 SSE 观测<a class="headerlink" href="#111-sse" title="Permanent link">&para;</a></h3>
<ul>
<li>
<p><code>xNet</code> 跟踪总用时（<code>t_all_</code>）、首包用时（<code>t_first_</code>）、超时保护（QTimer）。</p>
</li>
<li>
<p>收集 llama.cpp <code>timings.prompt_ms/prompt_n</code> 与 <code>timings.predicted_ms/predicted_n</code>，计算 prompt/gen tokens/s。</p>
</li>
<li>
<p>reasoning 流：支持 <code>&lt;think&gt;</code> 标签与第三方 <code>reasoning</code> 字段，UI 分流渲染。</p>
</li>
<li>
<p>KV 统计：本地模式取 server 日志，链接模式根据 <code>usage.prompt_tokens</code> 与流式增量估算。</p>
</li>
</ul>
<h3 id="112">11.2 模型评估模块<a class="headerlink" href="#112" title="Permanent link">&para;</a></h3>
<ul>
<li>
<p>入口：增殖窗口“模型评估”页；包含 Start/Stop 控件、表格与迷你柱状图（TTFB、生成、常识、逻辑、工具、同步率）。</p>
</li>
<li>
<p>运行：独立线程中的 <code>xNet</code> 负责请求；评估逻辑位于 <code>src/expend/expend_eval.cpp</code>。</p>
</li>
<li>
<p>测项：</p>
</li>
<li>
<p><strong>首包响应（TTFB）</strong>：发送 1024 个 'A'，收到首字符立即终止；500 ms 以上线性降分。</p>
</li>
<li>
<p><strong>生成速度</strong>：默认 2 轮长文本；优先使用服务器返回的 <code>gen_per_s</code>，否则以片段数量/时间估算。</p>
</li>
<li>
<p><strong>常识问答</strong>：<code>qa1..qa5</code> 单选题，解析答案字母与标准答案比对。</p>
</li>
<li>
<p><strong>逻辑题</strong>：<code>logic1..logic5</code> 单选题。</p>
</li>
<li>
<p><strong>工具调用</strong>：注入 6 项内置工具描述，要求仅输出一个 <code>&lt;tool_call&gt;</code>。</p>
</li>
<li>
<p><strong>同步率</strong>：<code>Sync = clamp(0,100,0.10*TTFB + 0.20*Gen + 0.20*QA + 0.20*Logic + 0.30*Tools)</code>。</p>
</li>
<li>
<p><strong>容错</strong>：网络错误触发 <code>WRONG_SIGNAL</code>，记录状态并终止流程；用户可随时 Stop。</p>
</li>
<li>
<p>UI 资源：<code>src/expend/expend.ui</code>、<code>src/utils/minibarchart.*</code>。</p>
</li>
</ul>
<h3 id="113-terminalpane">11.3 TerminalPane 监控<a class="headerlink" href="#113-terminalpane" title="Permanent link">&para;</a></h3>
<ul>
<li>
<p>保留 4000 行以内的命令输出，超限自动截断。</p>
</li>
<li>
<p>支持 Stop 按钮和 Ctrl+C；命令提示符包含工作目录。</p>
</li>
<li>
<p>供 <code>execute_command</code> 与 MCP 工具共享，也支持用户手动输入命令。</p>
</li>
</ul>
<h2 id="11-docker">11. Docker 沙盒机制<a class="headerlink" href="#11-docker" title="Permanent link">&para;</a></h2>
<p>EVA 在系统工程师工具下提供可选的 Docker 沙盒，保证模型的 <code>execute_command</code>/<code>read_file</code> 等操作在隔离环境中执行，同时仍能访问宿主工程目录。</p>
<h3 id="111">11.1 启用流程<a class="headerlink" href="#111" title="Permanent link">&para;</a></h3>
<ul>
<li>
<p>用户在“约定”面板勾选“系统工程师”后，可在同一行的下拉框中选择 Docker 沙盒模式：<code>None</code> 表示不启用（默认），<code>镜像</code> 表示使用本地镜像启动沙盒，<code>容器</code> 表示复用已有容器。选择镜像/容器时可继续填写镜像名或容器名，列表会根据 <code>docker images</code> / <code>docker ps -a</code> 自动补全。</p>
</li>
<li>
<p><code>Widget::syncDockerSandboxConfig</code> 汇总工作目录、镜像、启用标记，通过 <code>ui2tool_dockerConfigChanged</code> 下发给 xTool。</p>
</li>
<li>
<p>约定窗口提供“镜像模式 / 容器模式”切换。容器模式会列出 <code>docker ps -a</code> 中的容器，用户选择后 EVA 会自动在 <code>/eva_workspace</code> 重新挂载当前工程目录，并把 EVA 技能根目录映射到 <code>/eva_skills</code>；若容器已运行，会提示并先执行 restart。检测到所选容器缺少 <code>/eva_workspace</code> 或 <code>/eva_skills</code> bind mount 时，UI 会弹出确认对话框，确认后 EVA 会停止并重建该容器，使其挂载当前工程目录与技能目录后再恢复沙盒。</p>
</li>
<li>
<p>xTool 使用 <code>DockerSandbox</code>（<code>src/utils/docker_sandbox.*</code>）管理容器：  </p>
</li>
<li>
<p><code>applyConfig</code> 根据“工作目录 + 镜像”生成稳定的容器名（<code>eva-sandbox-&lt;hash&gt;</code>）；  </p>
</li>
<li>
<p>检查 docker 是否可用 → 镜像是否存在（必要时 <code>docker pull</code>）→ 容器是否存在；  </p>
</li>
<li>
<p>不存在时自动 <code>docker run -d --name &lt;hash&gt; -w /eva_workspace -v &lt;宿主工作目录&gt;:/eva_workspace -v &lt;技能目录&gt;:/eva_skills &lt;image&gt;</code>；存在但未运行则 <code>docker start</code>；</p>
</li>
<li>
<p>读取容器环境（<code>uname -sr</code>、<code>/etc/os-release</code>）并通过信号反馈给 UI。</p>
</li>
<li>
<p>EVA 会把容器状态附加到工程师提示词中，例如“Docker container (ubuntu:latest)”以及挂载点 <code>/eva_workspace</code>、<code>/eva_skills</code>。</p>
</li>
</ul>
<h3 id="112_1">11.2 路径映射与工具执行<a class="headerlink" href="#112_1" title="Permanent link">&para;</a></h3>
<ul>
<li>
<p>工程师工作目录默认为 <code>EVA_WORK</code>（可自定义），在沙盒模式下以 <code>/eva_workspace</code> 挂载；技能管理器的 <code>EVA_SKILLS</code> 目录会同步挂载到 <code>/eva_skills</code>，方便在容器内直接调用技能脚本。  </p>
</li>
<li>
<p>在 Docker 沙盒内，<code>read_file</code> / <code>write_file</code> / <code>replace_in_file</code> / <code>edit_in_file</code> 等工具可以直接填写容器绝对路径（以 <code>/</code> 开头），此时 EVA 会跳过宿主工作区校验，直接在容器内执行 <code>cat</code>/<code>tee</code> 等操作。仍然需要指挥员注意安全，避免向模型暴露不必要的宿主挂载。  </p>
</li>
<li>
<p>所有工程师工具调用都会先通过 <code>resolveHostPathWithinWorkdir</code> 校验路径是否位于工作根内，然后映射为容器路径。  </p>
</li>
<li>
<p><code>execute_command</code> 通过 <code>docker exec -i &lt;container&gt; /bin/sh -lc "&lt;cmd&gt;"</code> 运行；<code>read_file</code>/<code>write_file</code>/<code>replace_in_file</code>/<code>list_files</code> 等函数改为读取容器内文件（必要时执行 <code>mkdir -p</code>，写入用 <code>cat &gt; file</code>）。  </p>
</li>
<li>
<p>TerminalPane、Docker 状态栏实时显示容器名、镜像、挂载目录、OS 信息，避免模型误判执行环境。</p>
</li>
</ul>
<h3 id="113">11.3 持久化与生命周期<a class="headerlink" href="#113" title="Permanent link">&para;</a></h3>
<ul>
<li>
<p>镜像、容器名与启用状态持久化在 <code>EVA_TEMP/eva_config.ini</code> 中（键：<code>docker_sandbox_mode</code>、<code>docker_sandbox_checkbox</code>、<code>docker_sandbox_image</code>、<code>docker_sandbox_container</code>）。<code>docker_sandbox_mode</code> 支持 <code>none/image/container</code> 三种取值，旧版遗留的 <code>docker_sandbox_checkbox</code> 会兼容读取为镜像模式。  </p>
</li>
<li>
<p>启动时若工程师工具启用，UI 会从配置直接读取镜像并回填下拉框，随后刷新镜像列表；未检测完成前也会沿用该值。  </p>
</li>
<li>
<p>关闭应用时，<code>main.cpp</code> 会通过 <code>shutdownDockerSandbox()</code> 禁用沙盒并调用 <code>docker stop</code>，确保不会留下僵尸容器；下次启动仍会复用同一容器名，保留依赖缓存。  </p>
</li>
<li>
<p>若 Docker 命令不可用或权限不足，状态会显示失败原因，工程师提示词也会标记“Sandbox pending”。</p>
</li>
</ul>
<h3 id="114">11.4 兼容性与注意事项<a class="headerlink" href="#114" title="Permanent link">&para;</a></h3>
<ul>
<li>
<p>需要宿主系统已安装 Docker 且当前用户具备无密码的 <code>docker</code> 访问权限（Windows 使用 Docker Desktop，Linux 推荐加入 docker 组或 rootless Docker）。  </p>
</li>
<li>
<p>沙盒镜像应包含所需构建工具（git/cmake/g++/clang/node/python 等），EVA 不负责镜像定制。  </p>
</li>
<li>
<p>由于所有命令都在 <code>/eva_workspace</code> 内执行，而技能脚本可通过 <code>/eva_skills</code> 读取，请确保工程师工作目录与技能目录仅包含允许模型访问的内容。若需隔离多个项目，可为每个项目配置独立的工作目录。</p>
</li>
</ul>
<h2 id="12">12. 部署与发布<a class="headerlink" href="#12" title="Permanent link">&para;</a></h2>
<ul>
<li>
<p><strong>打包内容</strong>：</p>
</li>
<li>
<p>主程序 <code>build/bin/eva(.exe)</code>。</p>
</li>
<li>
<p><code>EVA_BACKEND</code>：llama.cpp / whisper / TTS / SD 可执行与依赖。</p>
</li>
<li>
<p>可选 <code>EVA_MODELS</code>：llm / embedding / speech2text / text2speech / text2image。</p>
</li>
<li>
<p>资源（图标、动画、字体）与许可证。</p>
</li>
<li>
<p><strong>启动守护</strong>：</p>
</li>
<li>
<p><code>SingleInstance</code> 保证按应用路径单实例，二次启动仅唤醒已有窗口。</p>
</li>
<li>
<p>启用 Qt 高 DPI 缩放与 <code>SarasaFixedCL-Regular.ttf</code> 字体，确保中英文字体一致。</p>
</li>
<li>
<p>AppImage 自动设置 <code>APPDIR</code>、<code>APPIMAGE</code>、<code>LD_LIBRARY_PATH</code>，支持 <code>EVA_BACKEND_ROOT</code> 环境变量。</p>
</li>
<li>
<p>启动时自动创建 <code>EVA_TEMP</code>、<code>EVA_WORK</code>、TTS 缓存目录，并为缺省配置写入 <code>eva_config.ini</code>。</p>
</li>
</ul>
<h2 id="13">13. 测试与验证<a class="headerlink" href="#13" title="Permanent link">&para;</a></h2>
<ul>
<li>
<p><strong>单元测试</strong>：覆盖工具参数校验、SSE 解析、工程师工具流。</p>
</li>
<li>
<p><strong>功能测试</strong>：本地/链接装载切换、工具循环、知识库嵌入与检索、ASR/TTS、文生图。</p>
</li>
<li>
<p><strong>端到端</strong>：快捷键、截图、录音、发送、工具调用链，含硬件/网络异常场景。</p>
</li>
<li>
<p><strong>兼容性</strong>：Windows/Linux、CPU/GPU、不同显存、端口冲突、多语言界面。</p>
</li>
</ul>
<h2 id="14">14. 关键文件索引<a class="headerlink" href="#14" title="Permanent link">&para;</a></h2>
<ul>
<li>
<p>本地后端管理：<code>src/xbackend.*</code></p>
</li>
<li>
<p>网络层与 SSE：<code>src/xnet.*</code></p>
</li>
<li>
<p>主窗口与流程：<code>src/widget/*</code></p>
</li>
<li>
<p>约定与工具：<code>src/prompt.*</code>、<code>src/xtool.*</code></p>
</li>
<li>
<p>MCP 客户端：<code>src/xmcp.*</code>、<code>src/mcp_tools.h</code></p>
</li>
<li>
<p>增殖窗口：<code>src/expend/*</code></p>
</li>
<li>
<p>历史与配置：<code>src/utils/history_store.*</code>、<code>EVA_TEMP/*</code></p>
</li>
<li>
<p>终端面板：<code>src/widget/terminal_pane.*</code></p>
</li>
<li>
<p>设备探测：<code>src/utils/devicemanager.*</code></p>
</li>
</ul>












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
          <button type="button" class="md-top md-icon" data-md-component="top" hidden>
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8z"/></svg>
  回到页面顶部
</button>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      
      <script id="__config" type="application/json">{"annotate": null, "base": "..", "features": ["navigation.top", "navigation.expand", "navigation.sections", "search.highlight", "search.suggest"], "search": "../assets/javascripts/workers/search.2c215733.min.js", "tags": null, "translations": {"clipboard.copied": "\u5df2\u590d\u5236", "clipboard.copy": "\u590d\u5236", "search.result.more.one": "\u5728\u8be5\u9875\u4e0a\u8fd8\u6709 1 \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.more.other": "\u5728\u8be5\u9875\u4e0a\u8fd8\u6709 # \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.none": "\u6ca1\u6709\u627e\u5230\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.one": "\u627e\u5230 1 \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.other": "# \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.placeholder": "\u952e\u5165\u4ee5\u5f00\u59cb\u641c\u7d22", "search.result.term.missing": "\u7f3a\u5c11", "select.version": "\u9009\u62e9\u5f53\u524d\u7248\u672c"}, "version": null}</script>
    
    
      <script src="../assets/javascripts/bundle.79ae519e.min.js"></script>
      
    
  </body>
</html>