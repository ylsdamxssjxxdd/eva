# EVA 系统优化方案（2026Q1）

> 目标：围绕**系统设计、性能、稳定性、易用性、标准性、扩展性**六个维度，给出可执行、可验收、可迭代的优化路线。  
> 范围：主机体 `Widget/Core/Service/Storage/Tool/Expend`，以及工程化流程（测试、文档、发布）。

---

## 1. 现状诊断（基于当前仓库）

### 1.1 设计与可维护性
- 核心模块体量偏大，职责边界仍有耦合：
  - `src/xtool.cpp` 约 `3404` 行
  - `src/widget/widget_link.cpp` 约 `1633` 行
  - `src/service/backend/backend_coordinator.cpp` 约 `1367` 行
  - `src/xnet.cpp` 约 `1273` 行
  - `src/widget/widget.h` 约 `1088` 行
- 现有分层方向正确（`core/session`、`core/toolflow`、`service/backend` 已拆出），但 UI 状态、会话编排、后端生命周期仍存在“跨文件共享状态 + 回调驱动”复杂路径，变更成本高。

### 1.2 性能
- `src` 内存在较多同步阻塞调用，`waitForFinished(...)` 出现约 `25` 处，存在 UI 卡顿风险（尤其在 I/O 慢、外部进程慢、Windows 环境下）。
- 输出区、状态区、工具回环在高频流式场景下存在重复刷新，仍有进一步“批量化更新/降频刷新”的优化空间。

### 1.3 稳定性
- 本地后端重启、端口回退、懒卸载、唤醒等场景已具备能力，但路径复杂，边界行为仍依赖多个标志位协同，容易出现“状态提前解锁/动画中断/竞态”类问题。
- 工具执行、控制器、docker、网络流是主要故障高风险面，需统一超时、取消、重试与错误码策略。

### 1.4 易用性
- 功能丰富，但交互负担偏重：模式切换、工具开关、设置重启影响范围、状态反馈的一致性仍可增强。
- 当前“状态提示 + 日志提示 + 控件可用性”是多源反馈，用户有时难以判断“现在能做什么/下一步该做什么”。

### 1.5 标准性
- 仍存在历史风格混用（命名风格、模块注释风格、错误信息结构化程度不统一）。
- 编译告警尚未完全收敛（当前构建有告警），应纳入质量门禁。
- `xconfig.h` 集中了大量配置与工具函数，需进一步拆分为“配置常量/类型定义/通用辅助”三层。

### 1.6 扩展性
- 新工具接入目前仍需跨多处修改（注册、执行、提示词拼装、UI开关/展示），应进一步降低为“声明式注册 + 自动挂载 + 可选 UI 配置”。
- 扩展能力（工具、MCP、技能）已具备基础，但缺少统一版本契约（schema version / capability matrix / compatibility policy）。

---

## 2. 优化目标（6 维）

1. **系统设计**：核心链路从“回调拼接”升级为“显式状态机 + 领域服务编排”，降低耦合。  
2. **性能**：减少主线程阻塞，优化流式渲染和工具执行路径，提升响应速度。  
3. **稳定性**：建立统一容错机制（超时、取消、重试、降级、恢复），压缩异常面。  
4. **易用性**：用统一交互语义表达状态，减少用户决策负担。  
5. **标准性**：建立统一工程规范（命名、错误码、配置、日志、测试门禁）。  
6. **扩展性**：形成可插拔能力模型（工具/MCP/技能），降低新能力接入成本。

---

## 3. 分阶段实施路线

## Phase 0：基线与治理（1~2 周）
- 建立统一基线采样：
  - 启动耗时、装载耗时、首 token 延迟、回合完成耗时、工具耗时。
  - 后端重启成功率、端口回退成功率、工具超时率。
- 建立质量门禁：
  - `cmake --build` 告警清零为目标（先收敛关键告警）。
  - `ctest` + smoke 作为最小门禁，新增稳定性回归清单。
- 产出：
  - `docs/性能稳定性基线.md`（建议新增）
  - `docs/错误码与故障分级规范.md`（建议新增）

## Phase 1：架构收敛（2~4 周）
- 目标：把“状态与流程”从散点逻辑中抽离成可验证结构。
- 动作：
  - 引入统一 UI 状态机（init/loading/pushing/normal/recording），由单入口驱动按钮可用性。
  - 引入后端生命周期状态机（stopped/starting/running/restarting/sleeping/waking/error）。
  - 收敛“装载/重载/唤醒/回退”路径，减少隐式标志位组合。
  - 将 `xconfig.h` 按职责拆分为：
    - `config_defaults.h`（默认值）
    - `config_types.h`（结构体/枚举）
    - `config_utils.h`（纯工具函数）
- 验收：
  - 典型状态路径可画成单一状态图并与代码一致。
  - 重载/唤醒/失败恢复路径具备自动化回归用例。

## Phase 2：性能与稳定专项（3~5 周）
- 目标：减少卡顿和异常，提升高负载下体验一致性。
- 动作：
  - 把主线程 `waitForFinished` 高风险调用迁移为异步任务 + 回调（优先工具、音频、docker、系统命令）。
  - 流式输出优化：批量 flush（例如 16~33ms 节流）+ 最终强一致刷新。
  - 工具执行统一超时策略：默认超时、可取消、超时分类错误码。
  - 网络与后端统一重试策略：指数退避 + 上限次数 + 明确降级动作。
  - 引入 watchdog 与健康探针：后端状态、代理状态、工具线程活性。
- 验收：
  - UI 主线程卡顿（>100ms）次数显著下降。
  - 回归场景（重载、端口冲突、工具超时、网络抖动）可稳定恢复。

## Phase 3：易用性与标准化（2~4 周）
- 目标：让“可理解、可预期、可恢复”成为默认体验。
- 动作：
  - 统一状态文案体系：每个状态必须回答“当前在做什么 / 用户能做什么 / 若失败怎么办”。
  - 统一设置影响说明：每个设置项标注“是否触发重启、影响范围、风险”。
  - 统一日志规范：
    - 人类可读（状态区）
    - 机器可解析（结构化日志）
  - 统一代码规范与目录规范，形成检查清单并落到 CI。
- 验收：
  - 新用户可在 5 分钟内完成装载、对话、工具调用闭环。
  - 设置修改后的结果可预期，无“静默失败/隐式重启”。

## Phase 4：扩展能力升级（3~6 周）
- 目标：降低新增能力开发成本，支持更长期演进。
- 动作：
  - 定义统一能力描述协议（Capability Schema）：
    - `name/version/input/output/timeout/retry/security`.
  - 工具接入改为声明式注册：
    - 注册后自动生成 prompt 挂载片段与参数校验。
  - MCP/Skill/Tool 三类能力统一映射层，支持最小适配接入。
  - 增加插件兼容策略（版本范围、弃用策略、回滚策略）。
- 验收：
  - 新增标准工具改造触点减少（目标：核心触点 <= 3 处）。
  - 能力升级/回滚可控，不破坏主流程。

---

## 4. 六维专项行动清单

## 4.1 系统设计
- 建立“双状态机”：
  - UI 状态机（交互）
  - 后端状态机（生命周期）
- 会话链路（Session）与后端链路（Backend）彻底解耦，通过事件总线通信。
- 禁止多组变量控制同一要素（与中央教条一致）。

## 4.2 性能
- 异步化所有外部进程等待路径（命令执行、docker、tts、whisper 等）。
- 输出渲染批处理，减少高频 QTextEdit 刷新。
- 对 SSE 解析、工具回环增加轻量统计，定位慢点。

## 4.3 稳定性
- 统一错误码与故障级别（INFO/WARN/ERROR/FATAL）。
- 统一超时与取消协议（网络、工具、进程、控制器）。
- 后端异常路径必须可恢复：自动重试 -> 降级 -> 人工干预提示。

## 4.4 易用性
- 所有关键动作给出明确可视反馈（开始/进行中/完成/失败）。
- 装载、重载、重置、设置确认路径做一致化交互设计。
- 增加“发生错误后推荐动作”提示模板，减少用户试错。

## 4.5 标准性
- 配置项统一归档（默认值、类型、迁移策略、UI 文案）。
- 编译告警清零治理与回归约束（新增告警必须解释）。
- 文档标准化：每个模块至少具备“职责、输入、输出、失败恢复”四段说明。

## 4.6 扩展性
- 形成统一“能力注册中心”（工具/MCP/技能）。
- schema version + compatibility matrix 作为升级入口。
- 新能力默认带测试样例与文档模板，避免“仅实现无沉淀”。

---

## 5. 验收指标（建议）

> 先在 Phase 0 采集基线，再按下列目标推进。

- **设计**
  - 超大文件治理：`>1200` 行核心源文件数量逐步下降（按季度下降）。
  - 关键流程状态图与代码一致率 100%（抽检）。
- **性能**
  - 首 token 延迟 P95 下降（目标 20%+，以基线为准）。
  - UI 卡顿次数（>100ms）下降（目标 50%+，以基线为准）。
- **稳定性**
  - 本地重载成功率、唤醒成功率、端口回退成功率 >= 99%。
  - 异常后可恢复率 >= 99%（无需重启应用）。
- **易用性**
  - 核心任务（装载→提问→工具→重置）新用户一次成功率 >= 95%。
- **标准性**
  - 构建告警数 = 0（基线告警逐步清零）。
  - 关键模块文档覆盖率 100%。
- **扩展性**
  - 新工具接入工时下降（目标 30%+，以历史均值为基线）。
  - 新工具至少配套 1 个自动化用例。

---

## 6. 风险与应对

- **风险 1：重构期间引入行为回归**
  - 应对：分阶段小步提交 + 每阶段可回滚 + 回归清单强制执行。
- **风险 2：性能优化破坏显示一致性**
  - 应对：批处理刷新保留“最终强一致刷新”兜底。
- **风险 3：标准化推进拖慢迭代速度**
  - 应对：先治理高风险模块，规范分层落地，不一次性全改。
- **风险 4：扩展协议变更影响存量工具**
  - 应对：协议版本化 + 兼容层 + 弃用窗口。

---

## 7. 近期优先级建议（先做这 10 件）

1. 建立统一 UI 状态机入口（禁止散点改按钮状态）。  
2. 建立后端生命周期状态机与事件映射。  
3. 梳理并异步化高风险 `waitForFinished` 路径（先工具与 docker）。  
4. 建立结构化错误码并接入状态区提示。  
5. 增加“装载/重载/唤醒/端口冲突”自动化回归。  
6. 流式输出做节流批处理，减少 UI 抖动。  
7. 将 `xconfig.h` 按职责拆分。  
8. 统一设置项“是否触发重启”的标识与提示。  
9. 建立工具能力描述协议（最小可用版本）。  
10. 建立文档与测试同步门禁（无文档/无测试不能合并高风险改动）。

---

## 8. 结论

当前 EVA 已具备良好的模块化基础与较完整功能面，但要达到“长期稳定运行 + 高可维护 + 高扩展效率”的目标，下一阶段必须从“功能叠加”转向“结构化治理”。 
本方案建议以**状态机收敛 + 异步化改造 + 标准化治理 + 能力协议化**为主线推进，在不牺牲现有体验的前提下，稳步提升设计质量与工程质量。

---

## 9. 已落实进展（持续更新）

- **后端生命周期状态统一**：新增 `BackendLifecycleState`，将启动/重启/唤醒/休眠/错误纳入统一状态流，修复重载时动画丢失与按钮提前解锁的竞态问题。  
- **本地后端重启异步化**：`LocalServerManager` 改为非阻塞重启流程（`restartInFlight + pending args`），移除重载路径中的同步等待，降低 UI 卡顿风险。  
- **工具能力协议化落地**：`ToolRegistry` 增加 `schema_version/timeout_ms/high_risk` 元信息与 `capabilityManifest` 输出，形成能力清单基线。  
- **工具执行策略接线**：`xTool` 接入能力元信息，按工具策略执行超时控制与高风险提示，并统一记录超时失败码。  
- **全工具超时看门狗**：新增调用级统一超时计时器（覆盖 `stablediffusion/MCP/execute_command` 等异步路径），超时后自动取消并安全收尾，避免工具链长期悬挂。  
- **超时处理收敛**：工具超时告警改为统一出口（去重、幂等、结构化错误码）；`docker exec` 等阻塞路径改为继承工具超时预算，避免固定 120s 卡死。  
- **生命周期状态机约束**：在 `xconfig.h` 增加后端生命周期迁移规则，`Widget` 状态设置统一校验并埋点，减少非法状态跳转带来的 UI/后端不同步问题。  
- **编译告警收敛（持续）**：修复设置窗口 `nctx` 滑条上限整型溢出告警，并清理工具读文件路径中的无效临时变量，减少构建噪声。  
- **构建告警清理**：清理 `expend_eval` 未使用评分变量、`expend_mcp` 过时 `toSet` 用法与 `skill_manager` 未使用函数；当前构建输出已无新增编译告警。  
- **可观测性增强**：新增 `PerfMetrics`（`EVA_TEMP/metrics/events.jsonl`），已接入回合与工具关键事件；后续可直接用于 P50/P95 与失败率统计。  
- **测试补强**：新增 `tool_registry_tests` 与 `perf_metrics_tests`，并完成构建与全量单测通过校验。  
- **设置变更判定收敛**：新增 `settings_change_analyzer`，将“需要重启后端”和“仅需重置会话”的判定逻辑统一到一个模块，移除设置确认里的重复比较分支；设置确认时新增动作提示（重启后端/重置会话/权限变更），并补充 `settings_change_analyzer_tests` 覆盖关键边界。  
- **网络错误码标准化推进**：`xNet` 的 HTTP/网络/SSL/超时/空流关键错误状态统一封装为 `EVA-NET-001`，并把空闲超时常量下沉到 `DEFAULT_NET_IDLE_TIMEOUT_MS`；新增 `eva_error_tests`，固定错误码标签与格式化输出契约。  
- **网络重试策略落地**：新增 `net_retry_policy`，为“首包前失败”场景提供可控重试（指数退避、上限重试、可重试错误判定），并在 `xNet` 接入 API 变更/用户停止对重试队列的中断处理；新增 `net_retry_policy_tests` 覆盖重试规则。  
- **后端恢复动作标准化**：新增 `recovery_guidance`，把后端错误码与“自动回退/改端口/改设备/检查后端包”等动作提示统一拼装；已接入 `backend_coordinator/xbackend` 的关键失败路径并新增 `recovery_guidance_tests`。  
