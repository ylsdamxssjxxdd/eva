文档解析
========

本文总结 EVA 目前支持的文档类型、核心解析策略以及最终输出效果。所有实现均位于 `src/utils/docparser.cpp`，在 Qt 生态下跨平台运行。

1. 文本与 Markdown  
   - `readPlainTextFile` 直接读取 UTF-8 文本。  
   - `markdownToText` 删除代码块、图片、链接、表格等 Markdown 装饰，仅保留可读文字，便于后续嵌入。  

2. WPS / DOC（二进制 Word）  
   - 使用自研 `CompoundFileReader` 解析 CFB：校验 `0xD0CF11E0A1B11AE1` 签名，按 FAT/miniFAT/DIFAT 遍历目录，自动定位 `WordDocument` 与 `0Table/1Table`。  
   - 通过 FIB (`fcMin/fcMac/fcClx`) 决定是否加载 piece-table，兼容 Unicode 与 Win1252 片段。  
   - `readWpsText` 输出段落文本，并过滤 Root Entry、模板名称等噪声；若结构损坏，则回退到 UTF-16 逐段扫描（`readWpsHeuristic`）。  

3. DOCX（OpenXML）  
   - `ZipArchiveReader` 直接解压 `word/document.xml`，`readDocxParagraph` 解析段落与 `w:pStyle`，Heading 样式自动映射到 `#`/`##` 等 Markdown 标题。  
   - 内嵌表格 `w:tbl` 递归解析成 `QList<QStringList>`，最终用 `| col |` 语法输出 Markdown 表格，换行转 `<br>`，避免列错位。  

4. XLSX  
   - `readXlsxText` 加载 `xl/sharedStrings.xml` 和所有 `xl/worksheets/sheet*.xml`。单元格按行收集后统一渲染为 Markdown 表格。  
   - 每张工作表使用 `## Sheet N` 标题区分，便于知识库定位。  

5. PPTX  
   - `readPptxText` 遍历 `ppt/slides/slide*.xml`，提取 `<a:p>/<a:t>` 文本。  
   - 每张幻灯片输出 `## Slide N`，段落转化为 `- item` 列表，`<a:br>` 映射为换行。  

6. 输出与使用效果  
   - 所有结构化结果最终都以 Markdown 表示：Heading 还原层级、列表凸显层次、表格一眼确认位置。  
   - 知识库上传入口支持 `.txt/.md/.doc/.docx/.pptx/.xlsx/.wps`，解析失败会在日志中提示。  
   - 单测位于 `tests/unit/docs/docparser_tests.cpp`，覆盖 doc/wps/xlsx/pptx 场景并校验 Markdown 片段。  

7. 回退与安全  
   - 当 ZIP/CFB 解析失败时自动降级到 UTF-16 片段扫描，确保至少拿到可嵌入文本。  
   - 抽取前统一去重、截断噪声，避免 Root Entry、模板路径等非正文污染知识库。  

8. WPS 专有格式（.et/.dps）  
   - `.et`（WPS 表格）与 `.dps`（WPS 演示）本质上也是 Compound File。我们直接读取 `Workbook` 与 `PowerPoint Document` 流，复用 UTF-16 片段提取，再按 Markdown（表格/列表）输出。  
   - 目前侧重文本抽取，复杂的样式或合并单元格暂不还原。若流损坏仍会回退到全文件扫描。  
