# 机体持久化方案（面向 24 小时长期助手）

> 目标：把 EVA 从“实验型对话”升级为**长时间稳定运行**、**可恢复**、**可审计**的全天候助手。
> 重点引入：**上下文压缩**、**定时任务**、**长链路执行优化**。
> 参考方向：`参考项目/openclaw-main` 的 Compaction / Memory Flush / Queue / Cron+Heartbeat / Lobster 思路。

---

## 1. 现状分析（基于当前代码）

### 1.1 已有持久化基础
- **历史会话**：`src/utils/history_store.h` 使用 `meta.json + messages.jsonl` 持久化（JSONL 追加写）。
- **会话恢复**：`Widget::restoreSessionById` 支持从 JSONL 还原并重建记录条。
- **配置落盘**：`EVA_TEMP/eva_config.ini` 统一保存设置、约定等。

### 1.2 工具调用链路
- `widget_toolflow.cpp` 既支持 `tool_call`（文本解析）也支持 `function_call`（工具结构化），并将结果追加到历史。
- `prompt.cpp` 统一生成工具 schema；工具启用即注入系统提示词。

### 1.3 UI 记录条（适合承载“压缩记录块”）
- `RecordRole` + `recordEntries_` 已构成“记录条/记录块”的数据模型。
- `recordBar` 支持显示不同角色颜色和图标；适合新增“压缩角色”。
- 输出区为**纯文本**，可通过颜色区分角色（符合你要求）。

结论：现有历史、工具、UI 能直接承接“压缩 + 调度 + 长链路”改造，只需补齐机制与持久化结构。

---

## 2. 持久化目录与结构（新增）

```
EVA_TEMP/
  eva_config.ini
  history/<sessionId>/{meta.json,messages.jsonl}
  compaction/<sessionId>/summary.jsonl
  memory/{MEMORY.md,YYYY-MM-DD.md}
  cron/
    jobs.json
    runs/<jobId>.jsonl
  workflows/<runId>.json
  artifacts/
```

- **compaction/**：保存压缩摘要（JSONL 追加），允许多次压缩留档。
- **memory/**：持久记忆（长期事实与偏好）与日记（临时记事）。
- **cron/**：任务定义与运行记录。
- **workflows/**：长链路执行的步骤状态与断点。
- **artifacts/**：大结果（长日志/大文本/图片）落盘，只在消息中引用。

---

## 3. 上下文压缩（Compaction）设计

### 3.1 触发条件（自动 + 手动）
- **自动触发**：根据 `kvUsed_ / slotCtxMax_` 逼近上限时触发。
  - 例：`kvUsed_ > slotCtxMax_ - reserveTokens`。
- **手动触发**：提供“压缩”指令或按钮（可放在约定/设置中）。

### 3.2 压缩流程（参考 openclaw compaction）
1) **预压缩记忆刷新（Memory Flush）**：
   - 触发前，先进行一次“静默记忆写入回合”。
   - 让模型把“长期有效内容”写入 `memory/`，避免被压缩遗漏。
2) **摘要生成**：
   - 选取“旧对话片段”生成摘要，保留最新 N 轮原文。
   - 摘要写入 `compaction/<sessionId>/summary.jsonl`。
3) **摘要注入会话**：
   - 将摘要作为新消息插入历史（建议 role=`compact`）。
   - 仅保留摘要 + 最新消息链路，达到窗口收缩。

### 3.3 摘要结构建议
```json
{
  "role": "compact",
  "summary": "...",
  "range": { "from": 0, "to": 42 },
  "tokens_before": 12000,
  "tokens_after": 5400,
  "ts": "2026-02-02T22:00:00+08:00"
}
```

### 3.4 UI 呈现（按你的要求）
- **输出区**：纯文本，摘要用**紫色**输出。
- **记录条**：新增“压缩角色”记录块（紫色、标记 C）。
- **点击记录块**：可编辑/查看摘要文本。

> 这部分已在记录条体系中落位：新增 `RecordRole::Compact` + 紫色配色 + 记录块标记。

### 3.5 防爆策略（长对话）
- 大工具输出：落盘到 `artifacts/`，只在消息里留下摘要和文件路径。
- 旧消息摘要：只保留“决策/结论/待办/长期事实”。

---

## 4. 定时任务（Scheduler）设计

### 4.1 工具调用方式（按你最新设定）
- **默认使用 `tool_call`**。
- **默认挂载系统工程师工具**，并扩展其中的定时任务工具。

建议工具名：`schedule_task`（系统工程师工具内置）

**Schema 示例（与 openclaw cron 思路对齐）**：
```json
{
  "action": "add|update|remove|enable|disable|get|list|run",
  "job": {
    "job_id": "optional",
    "name": "string",
    "schedule": {
      "kind": "at|every|cron",
      "at": "2026-02-03T09:00:00+08:00",
      "every_ms": 3600000,
      "cron": "0 7 * * *",
      "tz": "Asia/Shanghai"
    },
    "session": "main|isolated",
    "payload": { "message": "..." },
    "deliver": { "channel": "ui", "mode": "summary" },
    "enabled": true,
    "delete_after_run": false,
    "dedupe_key": "optional"
  }
}
```

### 4.2 调度器实现（前端内置）
- `SchedulerService`（QTimer 驱动）：只维护**最近一次触发**的单次定时器。
- 任务定义落盘：`EVA_TEMP/cron/jobs.json`。
- 运行记录落盘：`EVA_TEMP/cron/runs/<jobId>.jsonl`。
- 重启时重新加载并恢复下一次执行时间。

### 4.3 执行模式
- **main**：主会话系统事件（适合提醒、轻量巡检）。
- **isolated**：独立会话 `cron:<jobId>`，避免污染主上下文；结果摘要回写主会话。

### 4.4 UI（增殖窗口新增“定时任务页”）
- 列表字段：名称 / 状态 / 下次执行时间 / 倒计时。
- 点击任务显示详情（schedule/payload/最近执行记录/错误）。
- 支持：启用/禁用/立即执行/删除。
- 每次 `schedule_task` 调用后自动刷新列表。

---

## 5. 长链路执行优化（Queue + Workflow）

### 5.1 任务队列（参考 openclaw queue）
- **目标**：避免多个长任务并发冲突，保证稳定性与可恢复。
- **做法**：
  - 按 session 维度排队（同一会话串行）。
  - 全局并发上限（默认 1~2）。
  - 支持 `collect/steer/followup` 等消息合并策略。

### 5.2 工作流执行器（参考 Lobster 思路）
- **WorkflowRunner**：把多步工具链固化为“步骤图”。
- 每一步都有状态：`pending/running/done/failed`，并持久化到 `workflows/<runId>.json`。
- 支持断点恢复：崩溃后读取 JSON 继续。
- 长输出写入 `artifacts/`，正文只展示摘要 + 文件路径。

### 5.3 任务预算与降噪
- 每个 workflow 设定最大 token / 最大时间 / 最大工具调用次数。
- 失败时进入退避重试，超过阈值转为“失败摘要”。

---

## 6. 配置项建议（写入 xconfig.h + eva_config.ini）

```ini
# tool_call 默认
tool_call_mode_default = tool_call
engineer_tool_default = true

# compaction
compaction_enabled = true
compaction_reserve_tokens = 2000
compaction_keep_last_turns = 8
compaction_trigger_ratio = 0.85
memory_flush_enabled = true

# scheduler
cron_enabled = true
cron_min_interval_ms = 60000
cron_page_refresh_ms = 1000

# workflow/queue
workflow_enabled = true
queue_max_concurrent = 1
queue_debounce_ms = 1000
queue_overflow = summarize
```

---

## 7. 实施阶段（落地顺序）

**Phase A：默认行为调整**
- 默认 tool_call + 默认工程师工具。
- 工程师提示词改为“长期稳定工作 / 高质量交付 / 使用定时任务”。

**Phase B：上下文压缩**
- 压缩触发 + 记忆刷新 + 摘要持久化。
- UI 记录条新增“压缩记录块”。

**Phase C：定时任务**
- `schedule_task` 工具 + SchedulerService + cron 持久化。
- 增殖窗口新增“定时任务页”。

**Phase D：长链路优化**
- 队列系统 + WorkflowRunner + 断点恢复。

---

## 8. 结论
- 现有 EVA 架构已具备“持久化 + 记录条 + 工具链”基础。
- 通过 **Compaction + Scheduler + Workflow** 三件套，即可完成“24 小时长期助手”转型。
- UI 上只需：**纯文本输出 + 紫色压缩记录块**，与当前交互风格一致。

如确认方案，我将按 Phase A → D 逐步落地实现。
